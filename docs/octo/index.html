<!-- Standalone Generated By Octo (octo-ide.com) -->
<script>data={"program":":macro s8plane N {\n\t:byte { 0xF0 + N }\n\t:byte 0x01\n}\n\n:const NUM_ENEMIES 30\n:const ENEMY_SIZE 5\n:calc ENEMY_BYTES { NUM_ENEMIES * ENEMY_SIZE }\n\n\n: main\n  lores\n  render-title\n  v0 := key\n\n: main-redraw\n  v0 := 1\n  delay := v0\n  loop\n    v0 := delay\n    if v0 != 0 then\n  again\n\n  clock-tick\n  check-keys\n  check-shots\n  render-scene\n  explode-enemies\n  jump main-redraw\n\n: clock-tick\n  i := long tick\n  load v0 - v0 # Don't auto-increment i\n  v0 += 1\n  save v0\n  vF := 0b00111111\n  v0 &= vF\n  if v0 == 0 begin\n    i := long level-screen\n    save v0\n  end\n  if v0 == 0 then revive-enemies\n  return\n\n: check-shots\n  # Are we shooting?\n  i := long shooting\n  load v0\n  if v0 == 0 then return\n\n  # Check if we shot any aliens\n  i := long player\n  load v1\n  vC := v0\n  vD := v1\n  vE := 0\n  loop\n    i := long enemies\n    i += vE\n    load v0 - v3\n    # Don't blow up dead aliens\n    if v0 == 0 then jump check-shots-next-alien\n    if v0 > 2 then jump check-shots-next-alien\n    # Check if we hit this alien\n    v2 >>= v2\n    v2 >>= v2\n    if v2 > vC begin # Enemy is in front of player\n      v3 >>= v3\n      v3 >>= v3\n      v3 -= vD\n      v3 += 2\n      if v3 < 8 begin # Enemy is on same height as player\n        # Hit! Set enemy to explosion\n        v0 := 3\n        save v0\n        # Increast score\n        i := long score\n        load v0 - v0\n        v0 += 1\n        save v0\n        # Next level if score overflows\n        if v0 == 0 begin\n          i := long level\n          load v0 - v0\n          v0 += 1\n          save v0\n          v0 := 1\n          i := long level-screen\n          save v0\n          i := long tick\n          save v0\n          hide-enemies\n        end\n        # Make a beep\n        v0 := 1\n        buzzer := v0\n      end\n    end\n    : check-shots-next-alien\n    vE += 5\n    if vE == ENEMY_BYTES then return # Checked all NUM_ENEMIES enemies?\n  again\n\n# Make exploding enemies go boom\n: explode-enemies\n  # Pre-load current level for generate-enemy\n  i := long level\n  load vC - vC\n  vE := 0\n  loop\n    i := long enemies\n    i += vE\n    load v0 - v0\n    if v0 == 5 begin\n      generate-enemy\n    end\n    if v0 == 4 begin\n      v0 := 5\n      save v0\n    end\n    if v0 == 3 begin\n      v0 := 4\n      save v0\n    end\n    vE += 5\n    if vE == ENEMY_BYTES then return # Checked all NUM_ENEMIES enemies?\n  again\n\n# Revive enemies that have been disabled\n: revive-enemies\n  # Don't revive enemies while on \"Get ready\" level screen\n  i := long level-screen\n  load v0\n  if v0 == 1 then return\n  # Pre-load current level for generate-enemy\n  i := long level\n  load vC - vC\n  vE := 0\n  loop\n    i := long enemies\n    i += vE\n    load v0 - v0\n    if v0 == 0 then generate-enemy\n    vE += 5\n    if vE == ENEMY_BYTES then return # Checked all NUM_ENEMIES enemies?\n  again\n\n: hide-enemies\n  vE := 0\n  loop\n    i := long enemies\n    i += vE\n    v0 := 0\n    save v0\n    vE += 5\n    if vE == ENEMY_BYTES then return # Checked all NUM_ENEMIES enemies?\n  again\n  return\n\n# Generate a new wave of enemies\n: generate-enemies\n  # Pre-load current level for generate-enemy\n  i := long level\n  load vC - vC\n  vE := 0\n  i := long enemies\n  loop\n    generate-enemy\n    vE += 1\n    if vE == NUM_ENEMIES then return # Generated all NUM_ENEMIES enemies?\n  again\n\n: generate-enemy\n  # v0 / Type: 0, 1 or 2 (0 most likely)\n  v0 := random 3\n  if v0 == 3 then v0 := 0\n  # v1 / Vx: Negative number from -1 to -3\n  v2 := random 7\n  v2 >>= v2\n  if vF == 1 begin # 50% chance of -1\n    v1 := -1\n  else\n    v1 := 3\n    v2 &= v1\n    if v2 == 3 begin\n      v1 := -3 # 12.5% chance of -3\n    else\n      v1 := -2 # 37.5% chance of -2\n    end\n  end\n  # Add the current level as a speed boost (level must be in vC)\n  v1 -= vC\n  # v2 / X coordinate: always start on the right, fixed point 6.2 bits number\n  v2 := 0xFF\n  # v3 / Y coordinate: random between 0 and 15, fixed point 6.2 bits number\n  v3 := random 0x0F\n  v3 += 5\n  v3 <<= v3\n  v3 <<= v3\n  # v4 / Vy: Number from -1 to 1 (0 most likely)\n  v4 := 1\n  vF := random 3\n  v4 -= vF\n  if v4 == -2 then v4 := 0\n  # Save all values for this enemy\n  save v4\n  return\n\n\n# Show the contents of the display buffer on the screen\n: display-copy-values\n  0 1 8 16 24 32 40 48 56 15\n: display-copy\n  i := display-copy-values\n  load v9\n  i := display-buffer\n\n  s8plane 0xF\n  clear\n\n  s8plane 1\n  sprite v0 v1 15   i += v9\n  sprite v0 v3 15   i += v9\n  sprite v2 v1 15   i += v9\n  sprite v2 v3 15   i += v9\n  sprite v3 v1 15   i += v9\n  sprite v3 v3 15   i += v9\n  sprite v4 v1 15   i += v9\n  sprite v4 v3 15   i += v9\n  sprite v5 v1 15   i += v9\n  sprite v5 v3 15   i += v9\n  sprite v6 v1 15   i += v9\n  sprite v6 v3 15   i += v9\n  sprite v7 v1 15   i += v9\n  sprite v7 v3 15   i += v9\n  sprite v8 v1 15   i += v9\n  sprite v8 v3 15   i += v9\n\n  s8plane 2\n  sprite v0 v1 15   i += v9\n  sprite v0 v3 15   i += v9\n  sprite v2 v1 15   i += v9\n  sprite v2 v3 15   i += v9\n  sprite v3 v1 15   i += v9\n  sprite v3 v3 15   i += v9\n  sprite v4 v1 15   i += v9\n  sprite v4 v3 15   i += v9\n  sprite v5 v1 15   i += v9\n  sprite v5 v3 15   i += v9\n  sprite v6 v1 15   i += v9\n  sprite v6 v3 15   i += v9\n  sprite v7 v1 15   i += v9\n  sprite v7 v3 15   i += v9\n  sprite v8 v1 15   i += v9\n  sprite v8 v3 15   i += v9\n\n    s8plane 1\n  sprite v0 v1 15   i += v9\n  sprite v0 v3 15   i += v9\n  sprite v2 v1 15   i += v9\n  sprite v2 v3 15   i += v9\n  sprite v3 v1 15   i += v9\n  sprite v3 v3 15   i += v9\n  sprite v4 v1 15   i += v9\n  sprite v4 v3 15   i += v9\n  sprite v5 v1 15   i += v9\n  sprite v5 v3 15   i += v9\n  sprite v6 v1 15   i += v9\n  sprite v6 v3 15   i += v9\n  sprite v7 v1 15   i += v9\n  sprite v7 v3 15   i += v9\n  sprite v8 v1 15   i += v9\n  sprite v8 v3 15   i += v9\n\n    s8plane 1\n  sprite v0 v1 15   i += v9\n  sprite v0 v3 15   i += v9\n  sprite v2 v1 15   i += v9\n  sprite v2 v3 15   i += v9\n  sprite v3 v1 15   i += v9\n  sprite v3 v3 15   i += v9\n  sprite v4 v1 15   i += v9\n  sprite v4 v3 15   i += v9\n  sprite v5 v1 15   i += v9\n  sprite v5 v3 15   i += v9\n  sprite v6 v1 15   i += v9\n  sprite v6 v3 15   i += v9\n  sprite v7 v1 15   i += v9\n  sprite v7 v3 15   i += v9\n  sprite v8 v1 15   i += v9\n  sprite v8 v3 15   i += v9\n\n  return\n\n# Display buffer contains 8 * 15 * 2 bytes = 240 bytes per layer\n# 240 / 15 = 16. So either load 16 values 15 times or the other way around\n: display-clear-values\n  0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0\n: display-clear\n  i := display-clear-values\n  load vF\n  i := display-buffer\n\n  # Plane 1\n  save vF  save vF  save vF  save vF\n  save vF  save vF  save vF  save vF\n  save vF  save vF  save vF  save vF\n  save vF  save vF  save vF\n\n  # Plane 2\n  save vF  save vF  save vF  save vF\n  save vF  save vF  save vF  save vF\n  save vF  save vF  save vF  save vF\n  save vF  save vF  save vF\n\n  # Plane 3\n  save vF  save vF  save vF  save vF\n  save vF  save vF  save vF  save vF\n  save vF  save vF  save vF  save vF\n  save vF  save vF  save vF\n\n  # Plane 4\n  save vF  save vF  save vF  save vF\n  save vF  save vF  save vF  save vF\n  save vF  save vF  save vF  save vF\n  save vF  save vF  save vF\n  return\n\n# v0, v1 = complex sprite address\n# v2 = X coordinate\n# v3 = Y coordinate\n# Preserves v2 - v3\n# Destroys v0, v1, v4 - vA and i\n: display-complex-sprite\n  :alias layer vA\n\n  layer := 0\n  i := display-complex-sprite-address\n  save v1\n\n  loop\n    # Get i to point to the complex sprite\n    0xF0 0x00 # i := long ....\n  : display-complex-sprite-address\n    0x00 0x00\n    load v1\n    v4 := v1\n\n    # Done all layers? Then return\n    if layer == v0 then return\n\n    # Get pointer to the right sprite data\n    i += layer\n    i += layer\n    i += layer\n\n    # Get plane\n    load v0\n    v5 := v0\n\n    load v1\n    display-sprite\n\n    layer += 1\n  again\n\n# Render a sprite to the display buffer\n# v0, v1 = sprite address\n# v2 = X coordinate\n# v3 = Y coordinate\n# v4 = height (in pixels)\n# v5 = target plane (0-3, 4-7 for mask)\n# Preserves v2 - v5\n# Destroys v0, v1, v6 - v9 and i\n\n# Overhead: 5 instructions\n# Per row: ~38 instructions\n# Per shift: 7 instructions\n# So for 8x8 sprite at bad alignment: 5 + 8 * (38 + 7*7) = 701 instructions\n# For 8x8 sprite at good alignment: 5 + 8 * (38 + 2) = 325 instructions\n: display-sprite\n  :alias X v2\n  :alias Y v3\n  :alias height v4\n  :alias targetplane v5\n  :alias row v6\n  :alias leftPart v7\n  :alias rightPart v8\n  :alias offset v1\n  :alias temp1 v9\n\n  row := 0\n  i := display-sprite-address\n  save v1\n\n  # Normalize coordinates\n  v0 := 31\n  v3 &= v0\n  v0 := 63\n  v2 &= v0\n\n  loop\n    if row == height then return # Done\n    v0 := Y\n    v0 += row\n    if v0 == 30 then return # Overflowing bottom of screen, so done\n\n    # Get the sprite data to put on the display buffer\n    0xF0 0x00 # i := long ....\n  : display-sprite-address\n    0x00 0x00\n    i += row\n    load v0\n\n    offset := 0b00000111\n    offset &= X\n    rightPart := 0\n    leftPart := v0\n\n    # Do some shifting magic for unaligned sprites\n    loop\n      while offset != 0\n      rightPart >>= rightPart\n      leftPart >>= leftPart\n      if vF != 0 then rightPart += 128\n      offset -= 1\n    again\n\n    # Calculate place in buffer\n    offset := X\n    offset >>= offset\n    offset >>= offset\n    offset >>= offset\n    i := long display-buffer\n    # Get right plane\n    temp1 := targetplane\n    v0 := 3\n    temp1 &= v0\n    v0 := 240\n    loop\n      while temp1 > 0\n      i += v0\n      temp1 -= 1\n    again\n    # Get right column\n    v0 := 30 # rows\n    loop\n      while offset != 0\n      i += v0\n      offset -= 1\n    again\n    # Get right row\n    i += Y\n    i += row\n\n    # Write the new data to the buffer\n    load v0 - v0 # Don't auto-increment i\n    if targetplane > 3 begin\n      temp1 := 0xFF\n      leftPart ^= temp1\n      v0 &= leftPart\n    else\n      v0 |= leftPart\n    end\n    save v0 - v0\n    if X < 56 begin\n      vF := 30\n      i += vF\n      load v0 - v0\n      if targetplane > 3 begin\n        temp1 := 0xFF\n        rightPart ^= temp1\n        v0 &= rightPart\n      else\n        v0 |= rightPart\n      end\n      save v0 - v0\n    end\n\n    row += 1\n  again\n\n\n: render-score\n  i := long score\n  load v0\n  i := long numbers-bcd\n  bcd v0\n  load v2\n  vA := v1\n  vB := v2\n  v2 := 4\n  v3 := 0\n  render-number\n  v3 += 5\n  v0 := vA\n  render-number\n  v3 += 5\n  v0 := vB\n  jump render-number\n\n: render-level\n  i := long level\n  load v0\n  i := long numbers-bcd\n  bcd v0\n  load v2\n  vA := v1\n  vB := v2\n  v2 := 4\n  v3 := 16\n  render-number\n  v3 += 5\n  v0 := vA\n  render-number\n  v3 += 5\n  v0 := vB\n  jump render-number\n\n# v0 = number\n# v2 = X\n# v3 = Y\n: render-number\n  i := long numbers\n  i += v0\n  i += v0\n  load v1\n  v4 := 4 # height\n  v5 := 0 # plane\n  jump display-sprite\n\n\n\n\n: render-scene\n  display-clear\n  render-background\n  render-enemies\n  render-player\n  render-hud\n  render-score\n  render-level\n  i := long level-screen\n  load v0\n  if v0 == 1 then render-level-text\n  display-copy\n  return\n\n: render-background\n  i := long tick\n  load vE - vE\n\n  vD := vE\n  vD >>= vD\n  vD >>= vD\n  vD >>= vD\n  v0 := 7\n  v0 &= vD\n  v2 := 7\n  v2 -= v0 # X\n  v3 := 8 # Y\n  loop\n    :unpack long background2-sprite\n    display-complex-sprite\n    v2 += 8\n    if v2 < 64 then\n  again\n\n  vD := vE\n  vD >>= vD\n  vD >>= vD\n  v0 := 7\n  v0 &= vD\n  v2 := 7\n  v2 -= v0 # X\n  v3 := 12 # Y\n  loop\n    :unpack long background3-sprite\n    display-complex-sprite\n    v2 += 8\n    if v2 < 64 then\n  again\n\n  vD := vE\n  vD >>= vD\n  v0 := 7\n  v0 &= vD\n  v2 := 7\n  v2 -= v0 # X\n  v3 := 17 # Y\n  loop\n    :unpack long background4-sprite\n    display-complex-sprite\n    v2 += 8\n    if v2 < 64 then\n  again\n\n  v0 := 7\n  v0 &= vE\n  v2 := 7\n  v2 -= v0 # X\n  v3 := 22 # Y\n  loop\n    :unpack long background5-sprite\n    display-complex-sprite\n    v2 += 8\n    if v2 < 64 then\n  again\n\n  vE >>= vE\n  vE >>= vE\n  vE >>= vE\n  vE >>= vE\n  v0 := 7\n  v0 &= vE\n  v2 := 7\n  v2 -= v0 # X\n  v3 := 0 # Y\n  loop\n    :unpack long background1-sprite\n    display-complex-sprite\n    v2 += 8\n    if v2 < 64 then\n  again\n\n  return\n\n: render-player\n  i := player\n  load v2 - v3 # X and Y\n  :unpack long player-sprite\n  display-complex-sprite\n\n  # Are we shooting?\n  i := shooting\n  load v0\n  if v0 == 0 then return\n\n  # Show lasers\n  v2 += 3 # X\n  i := tick\n  load v0\n  v1 := 3\n  v0 &= v1\n  v2 += v0\n  v3 += 1 # Y\n  loop\n    :unpack long laser-sprite\n    display-complex-sprite\n    v3 += 4\n    :unpack long laser-sprite\n    display-complex-sprite\n    v3 -= 4\n    v2 += 6\n    if v2 < 60 then\n  again\n  return\n\n# This subroutine is also responsible for updating the enemy positions and for\n# bouncing them at the edges of the screen.\n: render-enemies\n  # Pre-load current level for generate-enemy\n  i := long level\n  load vC - vC\n  vE := 0\n  loop\n    if vE == ENEMY_BYTES then return # Checked all NUM_ENEMIES enemies\n\n    i := long enemies\n    i += vE\n    load v0 - v4 # Don't auto-increment i\n\n    if v0 != 0 begin # Is there an enemy in this slot?\n      v2 += v1\n      v3 += v4\n      save v0 - v4 # Don't auto-increment i\n\n      # Interpret X and Y coordinates as fixed point floats\n      v2 >>= v2 v2 >>= v2\n      v3 >>= v3 v3 >>= v3\n\n      if v2 == 0 begin\n        # Disappear on the left (and generate new enemy)\n        generate-enemy\n        i := long score\n        load v0 - v0\n        if v0 > 9 begin\n          v0 -= 10\n        else\n          v0 := 0\n        end\n        save v0\n      else\n        # Bounce top and bottom\n        if v3 == 0  then v4 := 1\n        if v3 == 25 then v4 := -1\n        v5 := 4\n        i += v5\n        save v4 - v4\n\n        # Select the right sprite\n        if v0 == 1 begin :unpack long enemy1-sprite end\n        if v0 == 2 begin :unpack long enemy2-sprite end\n        if v0 == 3 begin :unpack long explosion1-sprite end\n        if v0 == 4 begin :unpack long explosion2-sprite end\n        if v0 == 5 begin :unpack long explosion3-sprite end\n\n        # And show that cannon fodder!\n        display-complex-sprite\n      end\n    end\n    vE += 5\n  again\n\n: render-hud\n  # Plane 1\n  i := long hud-top-sprite\n  load vE\n  i := long display-buffer-plane1\n  save vE\n  i := long hud-bottom-sprite\n  load vE\n  i := long display-buffer-plane1-plus-15\n  save vE\n\n  # Plane 2\n  i := long hud-top-sprite\n  load vE\n  i := long display-buffer-plane2\n  save vE\n  i := long hud-bottom-sprite\n  load vE\n  i := long display-buffer-plane2-plus-15\n  save vE\n\n  # Plane 2\n  i := long hud-top-sprite\n  load vE\n  i := long display-buffer-plane3\n  save vE\n  i := long hud-bottom-sprite\n  load vE\n  i := long display-buffer-plane3-plus-15\n  save vE\n\n  # Plane 2\n  i := long hud-top-sprite\n  load vE\n  i := long display-buffer-plane4\n  save vE\n  i := long hud-bottom-sprite\n  load vE\n  i := long display-buffer-plane4-plus-15\n  save vE\n\n  return\n\n\n\n\n\n\n\n: player\n  10 10 # X, Y\n: shooting\n  0 # Boolean\n: level-screen\n  1 # Boolean\n\n: tick\n  0\n: wave\n  0\n: level\n  1\n: score\n  0\n: power\n  30\n\n:monitor player 2\n:monitor shooting 1\n:monitor tick 1\n:monitor wave 1\n:monitor level 1\n\n#####################\n# Non-blocking key input check\n# Updates the player data on input, checks for collisions\n# Destroys v0 - v3\n: check-keys\n  i := long player\n  load v0 - v2\n\n  v3 := OCTO_KEY_A\n  if v3 key begin\n    if v0 > 9 then v0 -= 1\n  end\n\n  v3 := OCTO_KEY_D\n  if v3 key begin\n    if v0 < 55 then v0 += 1\n  end\n\n  v3 := OCTO_KEY_W\n  if v3 key begin\n    if v1 > 0 then v1 -= 1\n  end\n\n  v3 := OCTO_KEY_S\n  if v3 key begin\n    if v1 < 23 then v1 += 1\n  end\n\n  v3 := OCTO_KEY_E\n  if v3 key then v2 := 1\n  if v3 -key then v2 := 0\n\n  save v0 - v2\n  return\n\n# Blocking \"press any key\" routine\n# (does play music though)\n# Returns pressed key in v5\n: wait-key-press\n  vA := 0\n: wait-key-press-loop\n  #clock-tick\n  if vA key then return\n  vA += 1\n  if vA != 16 then jump wait-key-press-loop\n  jump wait-key-press\n\n# Input: v0 = level number\n: render-level-text\n  create-empty-space\n  render-level-number\n  render-ready-string\n  render-level-string\n  return\n\n: create-empty-space\n  i := long display-buffer-plane1\n  clear-row\n  i := long display-buffer-plane2\n  clear-row\n  i := long display-buffer-plane3\n  clear-row\n  i := long display-buffer-plane4\n  clear-row\n  return\n\n: clear-row\n  v0 := 0\n  v1 := 0\n  v2 := 0\n  v3 := 0\n  v4 := 0\n  v5 := 0\n  v6 := 0\n\n  v7 := 0\n  v8 := 24\n  v9 := 9 # Top of black bar\n  vA := 6\n  i += v9\n  loop\n    save v0 - v6\n    i += vA\n    save v0 - v6\n    i += v8\n    v7 += 1\n    if v7 != 8 then\n  again\n  return\n\n: render-level-number\n  i := long level\n  load v4 - v4\n  i := numbers-bcd\n  bcd v4\n  load vA - vC\n  v4 := vB\n  v4 += 17\n  load-font\n  v2 := 40\n  v3 := 10 # Top of line one\n  v4 := 5 # Height\n  v5 := 2 # Plane\n  display-sprite\n  v4 := vC\n  v4 += 17\n  load-font\n  v2 := 44\n  v3 := 10 # Top of line one\n  v4 := 5 # Height\n  v5 := 2 # Plane\n  display-sprite\n  return\n\n: render-level-string\n  vB := 0\n  v2 := 19\n  v3 := 10 # Top of line one\n  loop\n    if vB == 5 then return\n    i := level-string\n    i += vB\n    load v4 - v4\n    load-font\n    load vA - vA\n    v4 := 5 # Height\n    v5 := 2 # Plane\n    display-sprite\n    v2 += vA\n    vB += 1\n  again\n\n: render-ready-string\n  vB := 0\n  v2 := 11\n  v3 := 16 # Top of line two\n  loop\n    if vB == 10 then return\n    i := get-ready-string\n    i += vB\n    load v4 - v4\n    load-font\n    load vA - vA\n    v4 := 5 # Height\n    v5 := 2 # Plane\n    display-sprite\n    v2 += vA\n    vB += 1\n  again\n\n# Get font address in both i and v0, v1\n# Input: v4 = ascii value\n: load-font\n  i := long font\n  :unpack long font\n  v4 <<= v4\n  v1 += v4\n  v0 += vF\n  v1 += v4\n  v0 += vF\n  v1 += v4\n  v0 += vF\n  v1 += 1\n  v0 += vF\n  i += v4\n  i += v4\n  i += v4\n  return\n\n\n\n: render-title\n  i := long title-screen\n  s8plane 0xF\n  v0 := 0\n  v1 := 0\n  v2 := 32\n  loop\n    sprite v0 v1 8\n    i += v2\n    v0 += 8\n    if v0 == 64 begin\n      v0 := 0\n      v1 += 8\n      if v1 == 32 then return\n    end\n  again\n\n\n\n\n: enemies # 30 of 'em\n  0 0 0 0 0 # Type, Vx, X, Y, Vy\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n  0 0 0 0 0\n\n:monitor enemies 50\n\n: display-buffer\n: display-buffer-plane1\n  # 4 planes of 7.5 times 32 bytes each. 240 bytes per layer, 960 bytes total.\n  # The image is layed out in consecutive vertical slices of 8 pixels wide\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n: display-buffer-plane1-plus-15\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\n: display-buffer-plane2\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n: display-buffer-plane2-plus-15\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\n: display-buffer-plane3\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n: display-buffer-plane3-plus-15\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\n: display-buffer-plane4\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n: display-buffer-plane4-plus-15\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\n: numbers-bcd\n  0 0 0\n\n\n: numbers\n  :pointer number-zero\n  :pointer number-one\n  :pointer number-two\n  :pointer number-three\n  :pointer number-four\n  :pointer number-five\n  :pointer number-six\n  :pointer number-seven\n  :pointer number-eight\n  :pointer number-nine\n\n: number-zero\n  0b00000000\n  0b11000000\n  0b11000000\n  0b11000000\n\n: number-one\n  0b01000000\n  0b01000000\n  0b01000000\n  0b01000000\n\n: number-two\n  0b10000000\n  0b01000000\n  0b10000000\n  0b11000000\n\n: number-three\n  0b10000000\n  0b01000000\n  0b01000000\n  0b10000000\n\n: number-four\n  0b10000000\n  0b10000000\n  0b11000000\n  0b01000000\n\n: number-five\n  0b11000000\n  0b10000000\n  0b01000000\n  0b10000000\n\n: number-six\n  0b01000000\n  0b10000000\n  0b11000000\n  0b11000000\n\n: number-seven\n  0b11000000\n  0b01000000\n  0b10000000\n  0b10000000\n\n: number-eight\n  0b11000000\n  0b11000000\n  0b11000000\n  0b11000000\n\n: number-nine\n  0b11000000\n  0b11000000\n  0b01000000\n  0b10000000\n\n# Colours used:\n# Light green   1101\n# Dark green    1001\n# Brown         0001\n# Light gray    0100\n\n: background1-sprite\n  2 # Number of layers\n  8 # Height\n  0 # Plane 0\n  :pointer background1-sprite-p0\n  1 # Plane 1\n  :pointer background1-sprite-p1\n\n: background1-sprite-p0\n  0b11111111\n  0b11110011\n  0b11100001\n  0b11111111\n  0b10011111\n  0b00001111\n  0b11111111\n  0b11111111\n\n: background1-sprite-p1\n  0b00000000\n  0b00001100\n  0b00011110\n  0b00000000\n  0b01100000\n  0b11110000\n  0b00000000\n  0b00000000\n\n: background2-sprite\n  2 # Number of layers\n  7 # Height\n  0 # Plane 0\n  :pointer background2-sprite-p0\n  1 # Plane 1\n  :pointer background2-sprite-p1\n\n: background2-sprite-p0\n  0b11101111\n  0b11001111\n  0b00000111\n  0b00010010\n  0b00001000\n  0b00000000\n  0b00000000\n\n: background2-sprite-p1\n  0b00010000\n  0b00111000\n  0b11111100\n  0b11111111\n  0b11111111\n  0b11111111\n  0b11111111\n\n: background3-sprite\n  3 # Number of layers\n  5 # Height\n  4 # Mask\n  :pointer background3-sprite-m\n  5 # Mask\n  :pointer background3-sprite-m\n  3 # Plane 3\n  :pointer background3-sprite-1\n\n: background3-sprite-m\n  0b00010000\n  0b00111100\n  0b01111110\n  0b11111111\n  0b11111111\n\n: background3-sprite-1\n  0b00000000\n  0b00110000\n  0b01111100\n  0b11011110\n  0b10111111\n\n: background4-sprite\n  4 # Number of layers\n  8 # Height\n  0 # Plane 0\n  :pointer background4-sprite-p0\n  1 # Plane 1\n  :pointer background4-sprite-p12\n  2 # Plane 2\n  :pointer background4-sprite-p12\n  3 # Plane 3\n  :pointer background4-sprite-p3\n\n: background4-sprite-p0\n  0b00011000\n  0b00111100\n  0b01110110\n  0b11111011\n  0b11011111\n  0b11111111\n  0b11111111\n  0b11111111\n\n: background4-sprite-p12\n  0b00010000\n  0b00100000\n  0b01000000\n  0b10000000\n  0b00000000\n  0b00000000\n  0b00000000\n  0b00000000\n\n: background4-sprite-p3\n  0b11111111\n  0b11111111\n  0b11111111\n  0b11111111\n  0b11111111\n  0b11111111\n  0b11111111\n  0b11111111\n\n: background5-sprite\n  3 # Number of layers\n  8 # Height\n  0 # Plane 0\n  :pointer background5-sprite-p01\n  1 # Plane 1\n  :pointer background5-sprite-p01\n  3 # Plane 3\n  :pointer background5-sprite-p3\n\n: background5-sprite-p01\n  0b00000000\n  0b00011100\n  0b01111110\n  0b11111111\n  0b11111111\n  0b11111111\n  0b11111111\n  0b00000000\n\n: background5-sprite-p3\n  0b00000000\n  0b00011000\n  0b01111100\n  0b11011110\n  0b11111011\n  0b10111111\n  0b11111111\n  0b11111111\n\n: player-sprite\n  6 # Number of layers\n  7 # Height\n  4 # Mask\n  :pointer player-sprite-m\n  5 # Mask\n  :pointer player-sprite-m\n  6 # Mask\n  :pointer player-sprite-m\n  7 # Mask\n  :pointer player-sprite-m\n  1 # Plane 1\n  :pointer player-sprite-p1\n  2 # Plane 3\n  :pointer player-sprite-p2\n\n: player-sprite-m\n  0b11100000\n  0b11111000\n  0b11111110\n  0b11111111\n  0b11111110\n  0b11111000\n  0b11100000\n\n: player-sprite-p1\n  0b00000000\n  0b01100000\n  0b01111000\n  0b01111110\n  0b01111000\n  0b01100000\n  0b00000000\n\n: player-sprite-p2\n  0b00000000\n  0b00000000\n  0b01111000\n  0b00000000\n  0b01111000\n  0b00000000\n  0b00000000\n\n: laser-sprite\n  4 # Number of layers\n  1 # Height\n  4 # Mask\n  :pointer laser-sprite-m\n  5 # Mask\n  :pointer laser-sprite-m\n  7 # Mask\n  :pointer laser-sprite-m\n  2 # Plane 2\n  :pointer laser-sprite-m\n\n: laser-sprite-m\n  0b00111000\n\n: enemy1-sprite\n  6 # Number of layers\n  4 # Height\n  4 # Mask\n  :pointer enemy1-sprite-m\n  5 # Mask\n  :pointer enemy1-sprite-m\n  6 # Mask\n  :pointer enemy1-sprite-m\n  7 # Mask\n  :pointer enemy1-sprite-m\n  1 # Plane 1\n  :pointer enemy1-sprite-p1\n  2 # Plane 2\n  :pointer enemy1-sprite-p2\n\n: enemy1-sprite-m\n  0b01111110\n  0b11111111\n  0b11111111\n  0b01111110\n\n: enemy1-sprite-p1\n  0b00000000\n  0b01010100\n  0b00000000\n  0b00000000\n\n: enemy1-sprite-p2\n  0b00000000\n  0b00101001\n  0b01111101\n  0b00000000\n\n: enemy2-sprite\n  6 # Number of layers\n  4 # Height\n  4 # Mask\n  :pointer enemy2-sprite-m\n  5 # Mask\n  :pointer enemy2-sprite-m\n  6 # Mask\n  :pointer enemy2-sprite-m\n  7 # Mask\n  :pointer enemy2-sprite-m\n  0 # Plane 0\n  :pointer enemy2-sprite-p0\n  1 # Plane 1\n  :pointer enemy2-sprite-p1\n\n: enemy2-sprite-m\n  0b00011000\n  0b01111110\n  0b11111111\n  0b01111110\n\n: enemy2-sprite-p0\n  0b00000000\n  0b00011000\n  0b01010100\n  0b00000000\n\n: enemy2-sprite-p1\n  0b00000000\n  0b00011000\n  0b00101010\n  0b00000000\n\n: explosion1-sprite\n  8 # Number of layers\n  5 # Height\n  4 # Mask\n  :pointer explosion1-sprite-m\n  5 # Mask\n  :pointer explosion1-sprite-m\n  6 # Mask\n  :pointer explosion1-sprite-m\n  7 # Mask\n  :pointer explosion1-sprite-m\n  0 # Plane 1\n  :pointer explosion1-sprite-p01\n  1 # Plane 1\n  :pointer explosion1-sprite-p01\n  2 # Plane 2\n  :pointer explosion1-sprite-p2\n  3 # Plane 3\n  :pointer explosion1-sprite-p3\n\n: explosion1-sprite-m\n  0b00000000\n  0b00111100\n  0b01111110\n  0b00111100\n  0b00000000\n\n: explosion1-sprite-p01\n  0b00000000\n  0b00111100\n  0b01000010\n  0b00111100\n  0b00000000\n\n: explosion1-sprite-p2\n  0b00000000\n  0b00111100\n  0b01100110\n  0b00111100\n  0b00000000\n\n: explosion1-sprite-p3\n  0b00000000\n  0b00000000\n  0b00011000\n  0b00000000\n  0b00000000\n\n: explosion2-sprite\n  8 # Number of layers\n  5 # Height\n  4 # Mask\n  :pointer explosion2-sprite-m\n  5 # Mask\n  :pointer explosion2-sprite-m\n  6 # Mask\n  :pointer explosion2-sprite-m\n  7 # Mask\n  :pointer explosion2-sprite-m\n  0 # Plane 1\n  :pointer explosion2-sprite-p01\n  1 # Plane 1\n  :pointer explosion2-sprite-p01\n  2 # Plane 2\n  :pointer explosion2-sprite-p2\n  3 # Plane 3\n  :pointer explosion2-sprite-p3\n\n: explosion2-sprite-m\n  0b00111100\n  0b01111110\n  0b01111110\n  0b01111110\n  0b00111100\n\n: explosion2-sprite-p01\n  0b00111100\n  0b01000010\n  0b01000010\n  0b01000010\n  0b00111100\n\n: explosion2-sprite-p2\n  0b00111100\n  0b01111110\n  0b01100110\n  0b01111110\n  0b00111100\n\n: explosion2-sprite-p3\n  0b00000000\n  0b00000000\n  0b00011000\n  0b00000000\n  0b00000000\n\n: explosion3-sprite\n  8 # Number of layers\n  5 # Height\n  4 # Mask\n  :pointer explosion3-sprite-m\n  5 # Mask\n  :pointer explosion3-sprite-m\n  6 # Mask\n  :pointer explosion3-sprite-m\n  7 # Mask\n  :pointer explosion3-sprite-m\n  0 # Plane 0\n  :pointer explosion3-sprite-p01\n  1 # Plane 1\n  :pointer explosion3-sprite-p01\n  2 # Plane 2\n  :pointer explosion3-sprite-p2\n  3 # Plane 3\n  :pointer explosion3-sprite-p3\n\n# Yellow  1110\n# Red     0010\n# Brown   0001\n\n: explosion3-sprite-m\n  0b01111110\n  0b11111111\n  0b11111111\n  0b11111111\n  0b01111110\n\n: explosion3-sprite-p01\n  0b01111110\n  0b10000001\n  0b11000011\n  0b10000001\n  0b01111110\n\n: explosion3-sprite-p2\n  0b01111110\n  0b11100111\n  0b11011011\n  0b11100111\n  0b01111110\n\n: explosion3-sprite-p3\n  0b00000000\n  0b00011000\n  0b00100100\n  0b00011000\n  0b00000000\n\n: hud-top-sprite\n  0b01100001\n  0b01100001\n  0b01000001\n  0b01000001\n  0b00000001\n  0b01000001\n  0b01100001\n  0b01000001\n  0b00100001\n  0b00000001\n  0b01100001\n  0b01000001\n  0b00100001\n  0b01100001\n  0b00000001\n\n: hud-bottom-sprite\n  0b00000001\n  0b01000001\n  0b01000001\n  0b01000001\n  0b01100001\n  0b00000001\n  0b00000001\n  0b10100001\n  0b10100001\n  0b01000001\n  0b00000001\n  0b01000001\n  0b01000001\n  0b01000001\n  0b01100001\n\n:stringmode ascii \"\\0 !\\\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\\\]^_`abcdefghijklmnopqrstuvwxyz{|}~\" {\n  :byte { VALUE }\n}\n\n: level-string\n  ascii \"Level\"\n\n: get-ready-string\n  ascii \"GET READY!\"\n\n#####################\n# Text font data\n\n: font\n\n  # Ascii 32 - 47: special characters\n\n  0\n  0 0 0 0 0 # Placeholder for end of string\n\n  2\n  0 0 0 0 0 # Space\n\n  2\n  0b10000000 # !\n  0b10000000\n  0b10000000\n  0b00000000\n  0b10000000\n\n  4\n  0b10100000 # \"\n  0b10100000\n  0b00000000\n  0b00000000\n  0b00000000\n\n  6\n  0b01010000 # #\n  0b11111000\n  0b01010000\n  0b11111000\n  0b01010000\n\n  6\n  0b01111000 # $\n  0b10100000\n  0b01110000\n  0b00101000\n  0b11110000\n\n  4\n  0b10100000 # %\n  0b00100000\n  0b01000000\n  0b10000000\n  0b10100000\n\n  5\n  0b01000000 # &\n  0b10100000\n  0b01000000\n  0b10100000\n  0b01110000\n\n  2\n  0b10000000 # '\n  0b10000000\n  0b00000000\n  0b00000000\n  0b00000000\n\n  3\n  0b01000000 # (\n  0b10000000\n  0b10000000\n  0b10000000\n  0b01000000\n\n  3\n  0b10000000 # )\n  0b01000000\n  0b01000000\n  0b01000000\n  0b10000000\n\n  6\n  0b00100000 # *\n  0b10101000\n  0b01110000\n  0b10101000\n  0b00100000\n\n  4\n  0b00000000 # +\n  0b01000000\n  0b11100000\n  0b01000000\n  0b00000000\n\n  3\n  0b00000000 # ,\n  0b00000000\n  0b00000000\n  0b01000000\n  0b10000000\n\n  4\n  0b00000000 # -\n  0b00000000\n  0b11100000\n  0b00000000\n  0b00000000\n\n  2\n  0b00000000 # .\n  0b00000000\n  0b00000000\n  0b00000000\n  0b10000000\n\n  4\n  0b00100000 # /\n  0b00100000\n  0b01000000\n  0b10000000\n  0b10000000\n\n: font-numbers\n\n  # Ascii 48 - 57: Numbers\n\n  5\n  0b01000000 # 0\n  0b10100000\n  0b10100000\n  0b10100000\n  0b01000000\n\n  4\n  0b01000000 # 1\n  0b11000000\n  0b01000000\n  0b01000000\n  0b11100000\n\n  5\n  0b11000000 # 2\n  0b00100000\n  0b01000000\n  0b10000000\n  0b11100000\n\n  5\n  0b11000000 # 3\n  0b00100000\n  0b01000000\n  0b00100000\n  0b11000000\n\n  5\n  0b10000000 # 4\n  0b10100000\n  0b11100000\n  0b00100000\n  0b00100000\n\n  5\n  0b11100000 # 5\n  0b10000000\n  0b11000000\n  0b00100000\n  0b11000000\n\n  5\n  0b01100000 # 6\n  0b10000000\n  0b11000000\n  0b10100000\n  0b01000000\n\n  5\n  0b11100000 # 7\n  0b00100000\n  0b01000000\n  0b10000000\n  0b10000000\n\n  5\n  0b01000000 # 8\n  0b10100000\n  0b01000000\n  0b10100000\n  0b01000000\n\n  5\n  0b01100000 # 9\n  0b10100000\n  0b01100000\n  0b00100000\n  0b01000000\n\n\n  # Ascii 58 - 64: More special characters\n\n  2\n  0b00000000 # :\n  0b10000000\n  0b00000000\n  0b10000000\n  0b00000000\n\n  3\n  0b00000000 # ;\n  0b01000000\n  0b00000000\n  0b01000000\n  0b10000000\n\n  4\n  0b00100000 # <\n  0b01000000\n  0b10000000\n  0b01000000\n  0b00100000\n\n  4\n  0b00000000 # =\n  0b11100000\n  0b00000000\n  0b11100000\n  0b00000000\n\n  4\n  0b10000000 # >\n  0b01000000\n  0b00100000\n  0b01000000\n  0b10000000\n\n  4\n  0b11000000 # ?\n  0b00100000\n  0b01000000\n  0b00000000\n  0b01000000\n\n  5\n  0b01100000 # @\n  0b10010000\n  0b10110000\n  0b10000000\n  0b01100000\n\n\n  # Ascii 65 - 90: Capital letters\n\n  5\n  0b01100000 # A\n  0b10010000\n  0b11110000\n  0b10010000\n  0b10010000\n\n  5\n  0b11100000 # B\n  0b10010000\n  0b11100000\n  0b10010000\n  0b11100000\n\n  5\n  0b01110000 # C\n  0b10000000\n  0b10000000\n  0b10000000\n  0b01110000\n\n  5\n  0b11100000 # D\n  0b10010000\n  0b10010000\n  0b10010000\n  0b11100000\n\n  4\n  0b11100000 # E\n  0b10000000\n  0b11100000\n  0b10000000\n  0b11100000\n\n  4\n  0b11100000 # F\n  0b10000000\n  0b11000000\n  0b10000000\n  0b10000000\n\n  5\n  0b01110000 # G\n  0b10000000\n  0b10110000\n  0b10010000\n  0b01100000\n\n  5\n  0b10010000 # H\n  0b10010000\n  0b11110000\n  0b10010000\n  0b10010000\n\n  4\n  0b11100000 # I\n  0b01000000\n  0b01000000\n  0b01000000\n  0b11100000\n\n  4\n  0b11100000 # J\n  0b00100000\n  0b00100000\n  0b00100000\n  0b11000000\n\n  5\n  0b10010000 # K\n  0b10100000\n  0b11000000\n  0b10100000\n  0b10010000\n\n  4\n  0b10000000 # L\n  0b10000000\n  0b10000000\n  0b10000000\n  0b11100000\n\n  6\n  0b10001000 # M\n  0b11011000\n  0b10101000\n  0b10001000\n  0b10001000\n\n  5\n  0b10010000 # N\n  0b11010000\n  0b11110000\n  0b10110000\n  0b10010000\n\n  5\n  0b01100000 # O\n  0b10010000\n  0b10010000\n  0b10010000\n  0b01100000\n\n  5\n  0b11100000 # P\n  0b10010000\n  0b11100000\n  0b10000000\n  0b10000000\n\n  5\n  0b01100000 # Q\n  0b10010000\n  0b10010000\n  0b10110000\n  0b01110000\n\n  5\n  0b11100000 # R\n  0b10010000\n  0b11100000\n  0b10010000\n  0b10010000\n\n  5\n  0b01110000 # S\n  0b10000000\n  0b01100000\n  0b00010000\n  0b11100000\n\n  6\n  0b11111000 # T\n  0b00100000\n  0b00100000\n  0b00100000\n  0b00100000\n\n  5\n  0b10010000 # U\n  0b10010000\n  0b10010000\n  0b10010000\n  0b01100000\n\n  5\n  0b10010000 # V\n  0b10010000\n  0b10010000\n  0b01100000\n  0b01100000\n\n  6\n  0b10001000 # W\n  0b10001000\n  0b10101000\n  0b11011000\n  0b10001000\n\n  6\n  0b10001000 # X\n  0b01010000\n  0b00100000\n  0b01010000\n  0b10001000\n\n  6\n  0b10001000 # Y\n  0b01010000\n  0b00100000\n  0b00100000\n  0b00100000\n\n  4\n  0b11100000 # Z\n  0b00100000\n  0b01000000\n  0b10000000\n  0b11100000\n\n\n  # Ascii 91 - 96: Even more special characters\n\n  3\n  0b11000000 # [\n  0b10000000\n  0b10000000\n  0b10000000\n  0b11000000\n\n  4\n  0b10000000 # \\\n  0b10000000\n  0b01000000\n  0b00100000\n  0b00100000\n\n  3\n  0b11000000 # ]\n  0b01000000\n  0b01000000\n  0b01000000\n  0b11000000\n\n  4\n  0b01000000 # ^\n  0b10100000\n  0b00000000\n  0b00000000\n  0b00000000\n\n  4\n  0b00000000 # _\n  0b00000000\n  0b00000000\n  0b00000000\n  0b11100000\n\n  3\n  0b10000000 # `\n  0b01000000\n  0b00000000\n  0b00000000\n  0b00000000\n\n\n  # Ascii 97 - 122: Lower case letters\n\n  4\n  0b00000000 # a\n  0b01100000\n  0b10100000\n  0b10100000\n  0b01100000\n\n  4\n  0b10000000 # b\n  0b10000000\n  0b11000000\n  0b10100000\n  0b11000000\n\n  4\n  0b00000000 # c\n  0b01100000\n  0b10000000\n  0b10000000\n  0b01100000\n\n  4\n  0b00100000 # d\n  0b00100000\n  0b01100000\n  0b10100000\n  0b01100000\n\n  4\n  0b00000000 # e\n  0b01000000\n  0b10100000\n  0b11000000\n  0b01100000\n\n  3\n  0b01000000 # f\n  0b10000000\n  0b11000000\n  0b10000000\n  0b10000000\n\n  4\n  0b00000000 # g\n  0b01100000\n  0b10100000\n  0b01100000\n  0b11000000\n\n  4\n  0b10000000 # h\n  0b10000000\n  0b11000000\n  0b10100000\n  0b10100000\n\n  2\n  0b10000000 # i\n  0b00000000\n  0b10000000\n  0b10000000\n  0b10000000\n\n  3\n  0b01000000 # j\n  0b00000000\n  0b01000000\n  0b01000000\n  0b10000000\n\n  4\n  0b10000000 # k\n  0b10000000\n  0b10100000\n  0b11000000\n  0b10100000\n\n  3\n  0b11000000 # l\n  0b01000000\n  0b01000000\n  0b01000000\n  0b01000000\n\n  4\n  0b00000000 # m\n  0b10100000\n  0b11100000\n  0b10100000\n  0b10100000\n\n  4\n  0b00000000 # n\n  0b11000000\n  0b10100000\n  0b10100000\n  0b10100000\n\n  4\n  0b00000000 # o\n  0b01000000\n  0b10100000\n  0b10100000\n  0b01000000\n\n  4\n  0b00000000 # P\n  0b11000000\n  0b10100000\n  0b11000000\n  0b10000000\n\n  4\n  0b00000000 # q\n  0b01100000\n  0b10100000\n  0b01100000\n  0b00100000\n\n  4\n  0b00000000 # r\n  0b10100000\n  0b11000000\n  0b10000000\n  0b10000000\n\n  3\n  0b00000000 # s\n  0b01000000\n  0b10000000\n  0b01000000\n  0b10000000\n\n  3\n  0b10000000 # t\n  0b10000000\n  0b11000000\n  0b10000000\n  0b01000000\n\n  4\n  0b00000000 # u\n  0b10100000\n  0b10100000\n  0b10100000\n  0b01000000\n\n  4\n  0b00000000 # v\n  0b10100000\n  0b10100000\n  0b01000000\n  0b01000000\n\n  4\n  0b00000000 # w\n  0b10100000\n  0b10100000\n  0b11100000\n  0b10100000\n\n  4\n  0b00000000 # x\n  0b10100000\n  0b01000000\n  0b01000000\n  0b10100000\n\n  4\n  0b00000000 # y\n  0b10100000\n  0b10100000\n  0b01000000\n  0b10000000\n\n  3\n  0b00000000 # z\n  0b11000000\n  0b01000000\n  0b10000000\n  0b11000000\n\n  # Ascii 123 - 126: Even more characters\n\n  4\n  0b01100000 # {\n  0b01000000\n  0b10000000\n  0b01000000\n  0b01100000\n\n  2\n  0b10000000 # |\n  0b10000000\n  0b10000000\n  0b10000000\n  0b10000000\n\n  4\n  0b11000000 # }\n  0b01000000\n  0b00100000\n  0b01000000\n  0b11000000\n\n  5\n  0b00000000\n  0b01010000 # ~\n  0b10100000\n  0b00000000\n  0b00000000\n\n: title-screen\n\n# Sprite 1 (4 layers, 8 bytes per layer)\n0x92 0x48 0x10 0x87 0x2c 0x48 0x0f 0x88\n0xed 0xb7 0xef 0x7f 0xdf 0xbf 0xff 0x7f\n0xb6 0xda 0x51 0xa7 0xac 0x48 0x4f 0x98\n0x92 0x48 0x1e 0x98 0x33 0x57 0x10 0x87\n\n# Sprite 2 (4 layers, 8 bytes per layer)\n0x49 0x92 0x00 0x34 0xb5 0x91 0x95 0x95\n0xb6 0xff 0xff 0xff 0xff 0xff 0xff 0xff\n0xdb 0xdb 0x24 0x34 0xb5 0x91 0x95 0x95\n0x49 0x92 0xdb 0xcb 0x4a 0x6e 0x6a 0x6a\n\n# Sprite 3 (4 layers, 8 bytes per layer)\n0x24 0x48 0x00 0xe7 0x96 0xf4 0x05 0x05\n0xdb 0xff 0xff 0xff 0xff 0xff 0xff 0xff\n0x6d 0x6a 0x90 0xe7 0x96 0xf4 0x04 0x04\n0x24 0x48 0x6f 0x18 0x69 0x0b 0xfa 0xfa\n\n# Sprite 4 (4 layers, 8 bytes per layer)\n0x92 0x49 0x00 0x95 0x40 0x4a 0x40 0x44\n0x6d 0xb6 0xff 0xea 0xff 0xf4 0xfe 0xfa\n0xb6 0xdb 0x15 0x95 0x4a 0x4a 0x48 0x44\n0x92 0x49 0xc0 0x75 0xa0 0xaa 0xa0 0xa4\n\n# Sprite 5 (4 layers, 8 bytes per layer)\n0x6b 0x1b 0x56 0x36 0xaa 0x00 0x00 0x00\n0xab 0xdb 0xd6 0xb6 0xff 0xab 0x00 0x7e\n0xd6 0x74 0x6d 0xed 0xaa 0x01 0x00 0x00\n0x40 0x40 0x40 0x80 0xaa 0xa8 0x00 0x00\n\n# Sprite 6 (4 layers, 8 bytes per layer)\n0x6e 0x6d 0xdd 0xdb 0xdb 0xaa 0x00 0x00\n0x6e 0x6d 0xdd 0xdb 0xdb 0x7f 0x2a 0x00\n0xdd 0xdb 0xbb 0xb7 0xb6 0xaa 0x00 0x00\n0x00 0x00 0x00 0x00 0x00 0xaa 0x2a 0x00\n\n# Sprite 7 (4 layers, 8 bytes per layer)\n0xed 0xdd 0xbb 0xb7 0x76 0x88 0x02 0x00\n0xed 0xdd 0xbb 0xb7 0x76 0x77 0x05 0x00\n0xdb 0xbb 0x76 0x6e 0xed 0xaa 0x02 0x00\n0x00 0x00 0x00 0x00 0x00 0x88 0x02 0x00\n\n# Sprite 8 (4 layers, 8 bytes per layer)\n0xbb 0xb7 0x76 0x6e 0xdd 0xdb 0xbb 0x08\n0xbb 0xb7 0x76 0x6e 0xdd 0xdb 0x7b 0x76\n0x77 0x6e 0xed 0xdd 0xbb 0xb6 0xb6 0x09\n0x00 0x00 0x00 0x00 0x00 0x00 0xa0 0x08\n\n# Sprite 9 (4 layers, 8 bytes per layer)\n0x28 0x00 0x00 0x70 0x26 0xa5 0x25 0x25\n0xdf 0xff 0xff 0xff 0xff 0x7f 0xff 0xff\n0x28 0x41 0x00 0x74 0x26 0x25 0x25 0x25\n0x35 0x1c 0xf8 0x8b 0xd9 0x5a 0x5a 0xda\n\n# Sprite 10 (4 layers, 8 bytes per layer)\n0x94 0x00 0x03 0x04 0x54 0x53 0x54 0x54\n0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff\n0x94 0x00 0x03 0xa4 0x54 0x53 0x54 0x54\n0x6b 0xff 0x0c 0x5b 0xab 0xac 0xab 0xab\n\n# Sprite 11 (4 layers, 8 bytes per layer)\n0xe4 0x00 0x04 0x80 0x9a 0x20 0x92 0x8a\n0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff\n0xe4 0x00 0x00 0x80 0x9a 0x20 0x92 0x8a\n0x1a 0xfe 0xc0 0x7f 0x65 0xdf 0x6d 0x75\n\n# Sprite 12 (4 layers, 8 bytes per layer)\n0x50 0x08 0x9a 0x00 0x4c 0xaa 0xaa 0xaa\n0xff 0xff 0xfd 0xff 0xff 0xff 0xff 0xff\n0x52 0x00 0x02 0x08 0x4c 0xaa 0xaa 0xaa\n0xb0 0xe0 0x02 0xf6 0xb3 0x55 0x55 0x55\n\n# Sprite 13 (4 layers, 8 bytes per layer)\n0x08 0x20 0x00 0x00 0x00 0x40 0xc0 0xa0\n0x34 0x19 0xb9 0x91 0xd3 0x83 0xe2 0xe2\n0x00 0x01 0x01 0x01 0x03 0x03 0x02 0x02\n0x00 0x00 0x80 0x00 0x00 0x00 0x00 0x00\n\n# Sprite 14 (4 layers, 8 bytes per layer)\n0x00 0x00 0x04 0x00 0x00 0x00 0x08 0x10\n0x67 0xef 0xda 0x9c 0xb0 0x60 0xc0 0x80\n0x60 0xe0 0xc0 0x80 0x80 0x00 0x00 0x00\n0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\n# Sprite 15 (4 layers, 8 bytes per layer)\n0x00 0x00 0x10 0x00 0x10 0x00 0x40 0x00\n0x00 0x30 0x2b 0x7b 0x2b 0x77 0xaf 0xdf\n0x00 0x00 0x03 0x03 0x03 0x07 0x0f 0x1f\n0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\n# Sprite 16 (4 layers, 8 bytes per layer)\n0x01 0x00 0x00 0x00 0x00 0x00 0x02 0x00\n0x22 0x00 0xf8 0xe1 0xe3 0xef 0x8d 0x9f\n0x01 0x00 0xf8 0xe0 0xe0 0xe0 0x80 0x80\n0x21 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\n# Sprite 17 (4 layers, 8 bytes per layer)\n0x75 0x00 0xfc 0xf4 0x09 0x72 0xf7 0xff\n0xff 0xff 0x3f 0xff 0xff 0xff 0xff 0xff\n0x75 0x00 0x00 0x00 0x00 0x00 0x62 0x54\n0x8a 0xff 0x00 0x00 0x00 0x00 0x00 0x00\n\n# Sprite 18 (4 layers, 8 bytes per layer)\n0x23 0x00 0x1c 0xdb 0xbd 0x74 0xff 0xff\n0xff 0xff 0xff 0xff 0x7f 0xff 0xff 0xff\n0x23 0x00 0x00 0x00 0x00 0x00 0x4d 0xa9\n0xdc 0xb7 0x00 0x00 0x00 0x00 0x00 0x00\n\n# Sprite 19 (4 layers, 8 bytes per layer)\n0x32 0x00 0xa0 0x40 0x81 0xa2 0xc1 0x82\n0xff 0xff 0xf8 0xf0 0xf1 0xc2 0xe1 0xc2\n0x32 0x00 0x00 0x00 0x00 0x00 0x80 0x00\n0xcd 0xfb 0x06 0x0b 0x0c 0x15 0x1a 0x2c\n\n# Sprite 20 (4 layers, 8 bytes per layer)\n0x4a 0x00 0x40 0xa0 0x50 0xa8 0x55 0x22\n0xff 0x7f 0x43 0xa1 0x50 0xa8 0x55 0x22\n0x4a 0x00 0x00 0x20 0x00 0x00 0x00 0x0e\n0xb5 0xff 0xb4 0x7c 0xa7 0x15 0xa2 0x91\n\n# Sprite 21 (4 layers, 8 bytes per layer)\n0x80 0x40 0x01 0x00 0x40 0x00 0x40 0x80\n0xc1 0xc1 0x90 0x33 0x71 0x31 0x40 0x80\n0x00 0x00 0x00 0xc0 0xc0 0x00 0x00 0x00\n0x00 0x00 0x00 0x00 0x00 0x40 0xa0 0x30\n\n# Sprite 22 (4 layers, 8 bytes per layer)\n0x20 0x20 0x00 0x00 0x00 0x08 0x00 0x01\n0x81 0x01 0x03 0x86 0x9d 0x32 0x30 0x00\n0x00 0x00 0x00 0x00 0x01 0x02 0x00 0x00\n0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\n# Sprite 23 (4 layers, 8 bytes per layer)\n0x00 0x80 0x00 0x00 0x03 0x03 0x86 0x8f\n0xdf 0x3c 0x70 0xe0 0x80 0x00 0x80 0x00\n0x1f 0x3c 0x70 0xe0 0x80 0x00 0x00 0x00\n0x00 0x00 0x00 0x00 0x00 0x01 0x02 0x07\n\n# Sprite 24 (4 layers, 8 bytes per layer)\n0x04 0x00 0x07 0xff 0xff 0xff 0xff 0xff\n0x18 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n0x00 0x00 0x05 0x0b 0x3b 0x7f 0xf8 0xf2\n0x00 0x00 0x02 0x74 0xc4 0x80 0x07 0x0d\n\n# Sprite 25 (4 layers, 8 bytes per layer)\n0xff 0xff 0x7e 0xff 0xff 0xff 0xff 0x7b\n0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff\n0x64 0x44 0x00 0x22 0x52 0x73 0x52 0x00\n0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\n# Sprite 26 (4 layers, 8 bytes per layer)\n0xff 0xff 0x7f 0x7f 0xff 0xfb 0xff 0xbb\n0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xfb\n0xc4 0x6d 0x00 0x12 0xaa 0x35 0x9a 0x40\n0x00 0x00 0x00 0x00 0x00 0x04 0x00 0x44\n\n# Sprite 27 (4 layers, 8 bytes per layer)\n0xd4 0xea 0xd1 0xeb 0xcd 0xca 0x14 0xa8\n0xd4 0xea 0xd1 0xeb 0xcd 0xca 0x14 0xa8\n0x80 0x80 0x00 0x80 0x80 0x00 0x01 0x03\n0x23 0x14 0x2a 0x04 0x32 0x24 0xaa 0x50\n\n# Sprite 28 (4 layers, 8 bytes per layer)\n0x44 0xa6 0x49 0x98 0x30 0x22 0x45 0xab\n0x44 0xa6 0x49 0x98 0x30 0x22 0x45 0xab\n0x1c 0x3c 0x38 0x70 0x60 0x00 0xc0 0x80\n0xa1 0x61 0x84 0x07 0x85 0x99 0x2a 0x14\n\n# Sprite 29 (4 layers, 8 bytes per layer)\n0x50 0x28 0x04 0x80 0x14 0x82 0x13 0xaa\n0x50 0x28 0x04 0x80 0x14 0x82 0x13 0xaa\n0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x08\n0xa8 0x44 0xa3 0x60 0x0a 0x45 0xa8 0x5c\n\n# Sprite 30 (4 layers, 8 bytes per layer)\n0x17 0x4f 0x00 0x41 0x03 0x83 0x47 0x9f\n0x17 0x7f 0xff 0x79 0x12 0x82 0x44 0x98\n0x00 0x00 0x00 0x07 0x0e 0x1e 0x3c 0x38\n0x00 0x00 0x00 0x80 0x61 0x21 0x83 0x47\n\n# Sprite 31 (4 layers, 8 bytes per layer)\n0x1f 0x7f 0xff 0xff 0xef 0xff 0xfe 0xff\n0x00 0x40 0x80 0x00 0x00 0x00 0x00 0x00\n0xc1 0xc2 0x0d 0x1b 0x06 0x2c 0x1e 0xfd\n0x0e 0x1d 0x72 0xe4 0xe9 0xd3 0xe0 0x02\n\n# Sprite 32 (4 layers, 8 bytes per layer)\n0xfb 0xff 0xef 0xff 0xbf 0xff 0xff 0xff\n0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n0xe1 0xc3 0x87 0x0f 0x9f 0x3f 0xff 0xff\n0x1a 0x3c 0x68 0xf0 0x20 0xc0 0x00 0x00","options":{"tickrate":200000,"fillColor":"#FFCC00","fillColor2":"#FF6600","blendColor":"#662200","backgroundColor":"#996600","buzzColor":"#FFAA00","quietColor":"#000000","shiftQuirks":false,"loadStoreQuirks":false,"vfOrderQuirks":false,"clipQuirks":false,"jumpQuirks":false,"logicQuirks":false,"vBlankQuirks":false,"screenRotation":0,"maxSize":3584,"touchInputMode":"none","fontStyle":"octo","displayScale":"6"},"rom":[0,254,41,97,240,10,96,1,240,21,240,7,48,0,18,10,34,28,40,43,34,58,38,68,34,184,18,6,240,0,8,38,80,3,112,1,240,85,111,63,128,242,48,0,18,52,240,0,8,37,240,85,64,0,34,230,0,238,240,0,8,36,240,101,64,0,0,238,240,0,8,34,241,101,140,0,141,16,110,0,240,0,9,129,254,30,80,51,64,0,18,176,111,2,143,5,79,0,18,176,130,38,130,38,143,192,143,37,63,0,18,176,131,54,131,54,131,213,115,2,111,8,143,55,63,0,18,176,96,3,240,85,240,0,8,41,80,3,112,1,240,85,48,0,18,172,240,0,8,40,80,3,112,1,240,85,96,1,240,0,8,37,240,85,240,0,8,38,240,85,35,12,96,1,240,24,126,5,78,150,0,238,18,80,240,0,8,40,92,195,110,0,240,0,9,129,254,30,80,3,48,5,18,206,35,56,48,4,18,214,96,5,240,85,48,3,18,222,96,4,240,85,126,5,78,150,0,238,18,192,240,0,8,37,240,101,64,1,0,238,240,0,8,40,92,195,110,0,240,0,9,129,254,30,80,3,64,0,35,56,126,5,78,150,0,238,18,248,110,0,240,0,9,129,254,30,96,0,240,85,126,5,78,150,0,238,19,14,0,238,240,0,8,40,92,195,110,0,240,0,9,129,35,56,126,1,78,30,0,238,19,46,192,3,64,3,96,0,194,7,130,38,63,1,19,74,97,255,19,88,97,3,130,18,50,3,19,86,97,253,19,88,97,254,129,197,98,255,195,15,115,5,131,62,131,62,100,1,207,3,132,245,68,254,100,0,244,85,0,238,0,1,8,16,24,32,40,48,56,15,163,114,249,101,170,23,255,1,0,224,241,1,208,31,249,30,208,63,249,30,210,31,249,30,210,63,249,30,211,31,249,30,211,63,249,30,212,31,249,30,212,63,249,30,213,31,249,30,213,63,249,30,214,31,249,30,214,63,249,30,215,31,249,30,215,63,249,30,216,31,249,30,216,63,249,30,242,1,208,31,249,30,208,63,249,30,210,31,249,30,210,63,249,30,211,31,249,30,211,63,249,30,212,31,249,30,212,63,249,30,213,31,249,30,213,63,249,30,214,31,249,30,214,63,249,30,215,31,249,30,215,63,249,30,216,31,249,30,216,63,249,30,241,1,208,31,249,30,208,63,249,30,210,31,249,30,210,63,249,30,211,31,249,30,211,63,249,30,212,31,249,30,212,63,249,30,213,31,249,30,213,63,249,30,214,31,249,30,214,63,249,30,215,31,249,30,215,63,249,30,216,31,249,30,216,63,249,30,241,1,208,31,249,30,208,63,249,30,210,31,249,30,210,63,249,30,211,31,249,30,211,63,249,30,212,31,249,30,212,63,249,30,213,31,249,30,213,63,249,30,214,31,249,30,214,63,249,30,215,31,249,30,215,63,249,30,216,31,249,30,216,63,249,30,0,238,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,164,144,255,101,170,23,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,255,85,0,238,106,0,165,40,241,85,240,0,0,0,241,101,132,16,154,0,0,238,250,30,250,30,250,30,240,101,133,0,241,101,37,68,122,1,21,38,102,0,165,96,241,85,96,31,131,2,96,63,130,2,150,64,0,238,128,48,128,100,64,30,0,238,240,0,0,0,246,30,240,101,97,7,129,34,104,0,135,0,65,0,21,126,136,134,135,118,63,0,120,128,113,255,21,110,129,32,129,22,129,22,129,22,240,0,10,23,137,80,96,3,137,2,96,240,111,0,143,149,63,0,21,160,240,30,121,255,21,146,96,30,65,0,21,172,240,30,113,255,21,162,243,30,246,30,80,3,111,3,143,85,63,0,21,194,105,255,135,147,128,114,21,196,128,113,80,2,111,56,143,39,63,0,21,232,111,30,255,30,80,3,111,3,143,85,63,0,21,228,105,255,136,147,128,130,21,230,128,129,80,2,118,1,21,82,240,0,8,41,240,101,240,0,13,215,240,51,242,101,138,16,139,32,98,4,99,0,38,52,115,5,128,160,38,52,115,5,128,176,22,52,240,0,8,40,240,101,240,0,13,215,240,51,242,101,138,16,139,32,98,4,99,16,38,52,115,5,128,160,38,52,115,5,128,176,22,52,240,0,13,218,240,30,240,30,241,101,100,4,101,0,21,68,36,160,38,96,39,64,39,4,39,192,37,236,38,16,240,0,8,37,240,101,64,1,40,133,35,124,0,238,240,0,8,38,94,227,141,224,141,214,141,214,141,214,96,7,128,210,98,7,130,5,99,8,96,14,97,46,37,32,114,8,111,64,143,39,79,0,22,120,141,224,141,214,141,214,96,7,128,210,98,7,130,5,99,12,96,14,97,68,37,32,114,8,111,64,143,39,79,0,22,152,141,224,141,214,96,7,128,210,98,7,130,5,99,17,96,14,97,89,37,32,114,8,111,64,143,39,79,0,22,182,96,7,128,226,98,7,130,5,99,22,96,14,97,127,37,32,114,8,111,64,143,39,79,0,22,208,142,230,142,230,142,230,142,230,96,7,128,226,98,7,130,5,99,0,96,14,97,22,37,32,114,8,111,64,143,39,79,0,22,242,0,238,168,34,82,51,96,14,97,154,37,32,168,36,240,101,64,0,0,238,114,3,168,38,240,101,97,3,128,18,130,4,115,1,96,14,97,195,37,32,115,4,96,14,97,195,37,32,115,252,114,6,111,60,143,39,79,0,23,36,0,238,240,0,8,40,92,195,110,0,78,150,0,238,240,0,9,129,254,30,80,67,64,0,23,188,130,20,131,68,80,66,130,38,130,38,131,54,131,54,50,0,23,132,35,56,240,0,8,41,80,3,111,9,143,5,63,0,23,126,112,246,23,128,96,0,240,85,23,188,67,0,100,1,67,25,100,255,101,4,245,30,84,66,48,1,23,154,96,14,97,210,48,2,23,162,96,14,97,242,48,3,23,170,96,15,97,18,48,4,23,178,96,15,97,64,48,5,23,186,96,15,97,110,37,32,126,5,23,72,240,0,15,156,254,101,240,0,10,23,254,85,240,0,15,171,254,101,240,0,10,38,254,85,240,0,15,156,254,101,240,0,11,7,254,85,240,0,15,171,254,101,240,0,11,22,254,85,240,0,15,156,254,101,240,0,11,247,254,85,240,0,15,171,254,101,240,0,12,6,254,85,240,0,15,156,254,101,240,0,12,231,254,85,240,0,15,171,254,101,240,0,12,246,254,85,0,238,10,10,0,1,0,0,1,0,30,240,0,8,34,80,35,99,7,227,158,24,63,111,9,143,5,79,0,112,255,99,9,227,158,24,77,111,55,143,7,79,0,112,1,99,5,227,158,24,91,111,0,143,21,79,0,113,255,99,8,227,158,24,105,111,23,143,23,79,0,113,1,99,6,227,161,98,1,227,158,98,0,80,34,0,238,106,0,234,161,0,238,122,1,58,16,24,121,24,119,40,143,40,209,41,31,40,255,0,238,240,0,10,23,40,169,240,0,11,7,40,169,240,0,11,247,40,169,240,0,12,231,40,169,0,238,96,0,97,0,98,0,99,0,100,0,101,0,102,0,103,0,104,24,105,9,106,6,249,30,80,98,250,30,80,98,248,30,119,1,55,8,24,193,0,238,240,0,8,40,84,67,173,215,244,51,90,195,132,176,116,17,41,63,98,40,99,10,100,5,101,2,37,68,132,192,116,17,41,63,98,44,99,10,100,5,101,2,37,68,0,238,107,0,98,19,99,10,75,5,0,238,175,186,251,30,84,67,41,63,90,163,100,5,101,2,37,68,130,164,123,1,25,5,107,0,98,11,99,16,75,10,0,238,175,191,251,30,84,67,41,63,90,163,100,5,101,2,37,68,130,164,123,1,25,37,240,0,15,201,96,15,97,201,132,78,129,68,128,244,129,68,128,244,129,68,128,244,113,1,128,244,244,30,244,30,244,30,0,238,240,0,18,9,255,1,96,0,97,0,98,32,208,24,242,30,112,8,48,64,25,127,96,0,113,8,65,32,0,238,25,109,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,13,238,13,242,13,246,13,250,13,254,14,2,14,6,14,10,14,14,14,18,0,192,192,192,64,64,64,64,128,64,128,192,128,64,64,128,128,128,192,64,192,128,64,128,64,128,192,192,192,64,128,128,192,192,192,192,192,192,64,128,2,8,0,14,30,1,14,38,255,243,225,255,159,15,255,255,0,12,30,0,96,240,0,0,2,7,0,14,54,1,14,61,239,207,7,18,8,0,0,16,56,252,255,255,255,255,3,5,4,14,79,5,14,79,3,14,84,16,60,126,255,255,0,48,124,222,191,4,8,0,14,103,1,14,111,2,14,111,3,14,119,24,60,118,251,223,255,255,255,16,32,64,128,0,0,0,0,255,255,255,255,255,255,255,255,3,8,0,14,138,1,14,138,3,14,146,0,28,126,255,255,255,255,0,0,24,124,222,251,191,255,255,6,7,4,14,174,5,14,174,6,14,174,7,14,174,1,14,181,2,14,188,224,248,254,255,254,248,224,0,96,120,126,120,96,0,0,0,120,0,120,0,0,4,1,4,14,209,5,14,209,7,14,209,2,14,209,56,6,4,4,14,230,5,14,230,6,14,230,7,14,230,1,14,234,2,14,238,126,255,255,126,0,84,0,0,0,41,125,0,6,4,4,15,6,5,15,6,6,15,6,7,15,6,0,15,10,1,15,14,24,126,255,126,0,24,84,0,0,24,42,0,8,5,4,15,44,5,15,44,6,15,44,7,15,44,0,15,49,1,15,49,2,15,54,3,15,59,0,60,126,60,0,0,60,66,60,0,0,60,102,60,0,0,0,24,0,0,8,5,4,15,90,5,15,90,6,15,90,7,15,90,0,15,95,1,15,95,2,15,100,3,15,105,60,126,126,126,60,60,66,66,66,60,60,126,102,126,60,0,0,24,0,0,8,5,4,15,136,5,15,136,6,15,136,7,15,136,0,15,141,1,15,141,2,15,146,3,15,151,126,255,255,255,126,126,129,195,129,126,126,231,219,231,126,0,24,36,24,0,97,97,65,65,1,65,97,65,33,1,97,65,33,97,1,1,65,65,65,97,1,1,161,161,65,1,65,65,65,97,45,70,87,70,77,40,38,53,1,51,38,34,37,58,2,0,0,0,0,0,0,2,0,0,0,0,0,2,128,128,128,0,128,4,160,160,0,0,0,6,80,248,80,248,80,6,120,160,112,40,240,4,160,32,64,128,160,5,64,160,64,160,112,2,128,128,0,0,0,3,64,128,128,128,64,3,128,64,64,64,128,6,32,168,112,168,32,4,0,64,224,64,0,3,0,0,0,64,128,4,0,0,224,0,0,2,0,0,0,0,128,4,32,32,64,128,128,5,64,160,160,160,64,4,64,192,64,64,224,5,192,32,64,128,224,5,192,32,64,32,192,5,128,160,224,32,32,5,224,128,192,32,192,5,96,128,192,160,64,5,224,32,64,128,128,5,64,160,64,160,64,5,96,160,96,32,64,2,0,128,0,128,0,3,0,64,0,64,128,4,32,64,128,64,32,4,0,224,0,224,0,4,128,64,32,64,128,4,192,32,64,0,64,5,96,144,176,128,96,5,96,144,240,144,144,5,224,144,224,144,224,5,112,128,128,128,112,5,224,144,144,144,224,4,224,128,224,128,224,4,224,128,192,128,128,5,112,128,176,144,96,5,144,144,240,144,144,4,224,64,64,64,224,4,224,32,32,32,192,5,144,160,192,160,144,4,128,128,128,128,224,6,136,216,168,136,136,5,144,208,240,176,144,5,96,144,144,144,96,5,224,144,224,128,128,5,96,144,144,176,112,5,224,144,224,144,144,5,112,128,96,16,224,6,248,32,32,32,32,5,144,144,144,144,96,5,144,144,144,96,96,6,136,136,168,216,136,6,136,80,32,80,136,6,136,80,32,32,32,4,224,32,64,128,224,3,192,128,128,128,192,4,128,128,64,32,32,3,192,64,64,64,192,4,64,160,0,0,0,4,0,0,0,0,224,3,128,64,0,0,0,4,0,96,160,160,96,4,128,128,192,160,192,4,0,96,128,128,96,4,32,32,96,160,96,4,0,64,160,192,96,3,64,128,192,128,128,4,0,96,160,96,192,4,128,128,192,160,160,2,128,0,128,128,128,3,64,0,64,64,128,4,128,128,160,192,160,3,192,64,64,64,64,4,0,160,224,160,160,4,0,192,160,160,160,4,0,64,160,160,64,4,0,192,160,192,128,4,0,96,160,96,32,4,0,160,192,128,128,3,0,64,128,64,128,3,128,128,192,128,64,4,0,160,160,160,64,4,0,160,160,64,64,4,0,160,160,224,160,4,0,160,64,64,160,4,0,160,160,64,128,3,0,192,64,128,192,4,96,64,128,64,96,2,128,128,128,128,128,4,192,64,32,64,192,5,0,80,160,0,0,146,72,16,135,44,72,15,136,237,183,239,127,223,191,255,127,182,218,81,167,172,72,79,152,146,72,30,152,51,87,16,135,73,146,0,52,181,145,149,149,182,255,255,255,255,255,255,255,219,219,36,52,181,145,149,149,73,146,219,203,74,110,106,106,36,72,0,231,150,244,5,5,219,255,255,255,255,255,255,255,109,106,144,231,150,244,4,4,36,72,111,24,105,11,250,250,146,73,0,149,64,74,64,68,109,182,255,234,255,244,254,250,182,219,21,149,74,74,72,68,146,73,192,117,160,170,160,164,107,27,86,54,170,0,0,0,171,219,214,182,255,171,0,126,214,116,109,237,170,1,0,0,64,64,64,128,170,168,0,0,110,109,221,219,219,170,0,0,110,109,221,219,219,127,42,0,221,219,187,183,182,170,0,0,0,0,0,0,0,170,42,0,237,221,187,183,118,136,2,0,237,221,187,183,118,119,5,0,219,187,118,110,237,170,2,0,0,0,0,0,0,136,2,0,187,183,118,110,221,219,187,8,187,183,118,110,221,219,123,118,119,110,237,221,187,182,182,9,0,0,0,0,0,0,160,8,40,0,0,112,38,165,37,37,223,255,255,255,255,127,255,255,40,65,0,116,38,37,37,37,53,28,248,139,217,90,90,218,148,0,3,4,84,83,84,84,255,255,255,255,255,255,255,255,148,0,3,164,84,83,84,84,107,255,12,91,171,172,171,171,228,0,4,128,154,32,146,138,255,255,255,255,255,255,255,255,228,0,0,128,154,32,146,138,26,254,192,127,101,223,109,117,80,8,154,0,76,170,170,170,255,255,253,255,255,255,255,255,82,0,2,8,76,170,170,170,176,224,2,246,179,85,85,85,8,32,0,0,0,64,192,160,52,25,185,145,211,131,226,226,0,1,1,1,3,3,2,2,0,0,128,0,0,0,0,0,0,0,4,0,0,0,8,16,103,239,218,156,176,96,192,128,96,224,192,128,128,0,0,0,0,0,0,0,0,0,0,0,0,0,16,0,16,0,64,0,0,48,43,123,43,119,175,223,0,0,3,3,3,7,15,31,0,0,0,0,0,0,0,0,1,0,0,0,0,0,2,0,34,0,248,225,227,239,141,159,1,0,248,224,224,224,128,128,33,0,0,0,0,0,0,0,117,0,252,244,9,114,247,255,255,255,63,255,255,255,255,255,117,0,0,0,0,0,98,84,138,255,0,0,0,0,0,0,35,0,28,219,189,116,255,255,255,255,255,255,127,255,255,255,35,0,0,0,0,0,77,169,220,183,0,0,0,0,0,0,50,0,160,64,129,162,193,130,255,255,248,240,241,194,225,194,50,0,0,0,0,0,128,0,205,251,6,11,12,21,26,44,74,0,64,160,80,168,85,34,255,127,67,161,80,168,85,34,74,0,0,32,0,0,0,14,181,255,180,124,167,21,162,145,128,64,1,0,64,0,64,128,193,193,144,51,113,49,64,128,0,0,0,192,192,0,0,0,0,0,0,0,0,64,160,48,32,32,0,0,0,8,0,1,129,1,3,134,157,50,48,0,0,0,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,128,0,0,3,3,134,143,223,60,112,224,128,0,128,0,31,60,112,224,128,0,0,0,0,0,0,0,0,1,2,7,4,0,7,255,255,255,255,255,24,0,0,0,0,0,0,0,0,0,5,11,59,127,248,242,0,0,2,116,196,128,7,13,255,255,126,255,255,255,255,123,255,255,255,255,255,255,255,255,100,68,0,34,82,115,82,0,0,0,0,0,0,0,0,0,255,255,127,127,255,251,255,187,255,255,255,255,255,255,255,251,196,109,0,18,170,53,154,64,0,0,0,0,0,4,0,68,212,234,209,235,205,202,20,168,212,234,209,235,205,202,20,168,128,128,0,128,128,0,1,3,35,20,42,4,50,36,170,80,68,166,73,152,48,34,69,171,68,166,73,152,48,34,69,171,28,60,56,112,96,0,192,128,161,97,132,7,133,153,42,20,80,40,4,128,20,130,19,170,80,40,4,128,20,130,19,170,0,0,0,0,0,0,0,8,168,68,163,96,10,69,168,92,23,79,0,65,3,131,71,159,23,127,255,121,18,130,68,152,0,0,0,7,14,30,60,56,0,0,0,128,97,33,131,71,31,127,255,255,239,255,254,255,0,64,128,0,0,0,0,0,193,194,13,27,6,44,30,253,14,29,114,228,233,211,224,2,251,255,239,255,191,255,255,255,0,0,0,0,0,0,0,0,225,195,135,15,159,63,255,255,26,60,104,240,32,192]}</script>
<script>"use strict";

function invertKeymap(k) {
	return Object.keys(k).reduce((a,b) => {
		Object.keys(k[b]).forEach(x => a[x]=+b)
		return a
	}, {})
}

function getPref(key) {
	try { return JSON.parse(localStorage.getItem(key)) }
	catch(e) { console.log(e); return null }
}
function setPref(key, value) {
	try { localStorage.setItem(key, JSON.stringify(value)) }
	catch(e) { console.log(e); }
}

var keymap = (this.STATIC_KEYMAP) || getPref('octoKeymap') || {
	0x0: { x:1 },
	0x1: { 1:1 },
	0x2: { 2:1 },
	0x3: { 3:1 },
	0x4: { q:1 },
	0x5: { w:1, ArrowUp:1 },
	0x6: { e:1, ' ':1 },
	0x7: { a:1, ArrowLeft:1 },
	0x8: { s:1, ArrowDown:1 },
	0x9: { d:1, ArrowRight:1 },
	0xA: { z:1 },
	0xB: { c:1 },
	0xC: { 4:1 },
	0xD: { r:1 },
	0xE: { f:1 },
	0xF: { v:1 },
}

var keymapInverse = invertKeymap(keymap)

var smallfonts = {
	octo: [
		0xF0, 0x90, 0x90, 0x90, 0xF0, // 0
		0x20, 0x60, 0x20, 0x20, 0x70, // 1
		0xF0, 0x10, 0xF0, 0x80, 0xF0, // 2
		0xF0, 0x10, 0xF0, 0x10, 0xF0, // 3
		0x90, 0x90, 0xF0, 0x10, 0x10, // 4
		0xF0, 0x80, 0xF0, 0x10, 0xF0, // 5
		0xF0, 0x80, 0xF0, 0x90, 0xF0, // 6
		0xF0, 0x10, 0x20, 0x40, 0x40, // 7
		0xF0, 0x90, 0xF0, 0x90, 0xF0, // 8
		0xF0, 0x90, 0xF0, 0x10, 0xF0, // 9
		0xF0, 0x90, 0xF0, 0x90, 0x90, // A
		0xE0, 0x90, 0xE0, 0x90, 0xE0, // B
		0xF0, 0x80, 0x80, 0x80, 0xF0, // C
		0xE0, 0x90, 0x90, 0x90, 0xE0, // D
		0xF0, 0x80, 0xF0, 0x80, 0xF0, // E
		0xF0, 0x80, 0xF0, 0x80, 0x80, // F
	],
	vip: [
		0xF0, 0x90, 0x90, 0x90, 0xF0,
		0x60, 0x20, 0x20, 0x20, 0x70,
		0xF0, 0x10, 0xF0, 0x80, 0xF0,
		0xF0, 0x10, 0xF0, 0x10, 0xF0,
		0xA0, 0xA0, 0xF0, 0x20, 0x20,
		0xF0, 0x80, 0xF0, 0x10, 0xF0,
		0xF0, 0x80, 0xF0, 0x90, 0xF0,
		0xF0, 0x10, 0x10, 0x10, 0x10,
		0xF0, 0x90, 0xF0, 0x90, 0xF0,
		0xF0, 0x90, 0xF0, 0x10, 0xF0,
		0xF0, 0x90, 0xF0, 0x90, 0x90,
		0xF0, 0x50, 0x70, 0x50, 0xF0,
		0xF0, 0x80, 0x80, 0x80, 0xF0,
		0xF0, 0x50, 0x50, 0x50, 0xF0,
		0xF0, 0x80, 0xF0, 0x80, 0xF0,
		0xF0, 0x80, 0xF0, 0x80, 0x80,
	],
	dream6800: [
		0xE0, 0xA0, 0xA0, 0xA0, 0xE0,
		0x40, 0x40, 0x40, 0x40, 0x40,
		0xE0, 0x20, 0xE0, 0x80, 0xE0,
		0xE0, 0x20, 0xE0, 0x20, 0xE0,
		0x80, 0xA0, 0xA0, 0xE0, 0x20,
		0xE0, 0x80, 0xE0, 0x20, 0xE0,
		0xE0, 0x80, 0xE0, 0xA0, 0xE0,
		0xE0, 0x20, 0x20, 0x20, 0x20,
		0xE0, 0xA0, 0xE0, 0xA0, 0xE0,
		0xE0, 0xA0, 0xE0, 0x20, 0xE0,
		0xE0, 0xA0, 0xE0, 0xA0, 0xA0,
		0xC0, 0xA0, 0xE0, 0xA0, 0xC0,
		0xE0, 0x80, 0x80, 0x80, 0xE0,
		0xC0, 0xA0, 0xA0, 0xA0, 0xC0,
		0xE0, 0x80, 0xE0, 0x80, 0xE0,
		0xE0, 0x80, 0xC0, 0x80, 0x80,
	],
	eti660: [
		0xE0, 0xA0, 0xA0, 0xA0, 0xE0,
		0x20, 0x20, 0x20, 0x20, 0x20,
		0xE0, 0x20, 0xE0, 0x80, 0xE0,
		0xE0, 0x20, 0xE0, 0x20, 0xE0,
		0xA0, 0xA0, 0xE0, 0x20, 0x20,
		0xE0, 0x80, 0xE0, 0x20, 0xE0,
		0xE0, 0x80, 0xE0, 0xA0, 0xE0,
		0xE0, 0x20, 0x20, 0x20, 0x20,
		0xE0, 0xA0, 0xE0, 0xA0, 0xE0,
		0xE0, 0xA0, 0xE0, 0x20, 0xE0,
		0xE0, 0xA0, 0xE0, 0xA0, 0xA0,
		0x80, 0x80, 0xE0, 0xA0, 0xE0,
		0xE0, 0x80, 0x80, 0x80, 0xE0,
		0x20, 0x20, 0xE0, 0xA0, 0xE0,
		0xE0, 0x80, 0xE0, 0x80, 0xE0,
		0xE0, 0x80, 0xC0, 0x80, 0x80,
	],
	fish: [
		0x60, 0xA0, 0xA0, 0xA0, 0xC0,
		0x40, 0xC0, 0x40, 0x40, 0xE0,
		0xC0, 0x20, 0x40, 0x80, 0xE0,
		0xC0, 0x20, 0x40, 0x20, 0xC0,
		0x20, 0xA0, 0xE0, 0x20, 0x20,
		0xE0, 0x80, 0xC0, 0x20, 0xC0,
		0x40, 0x80, 0xC0, 0xA0, 0x40,
		0xE0, 0x20, 0x60, 0x40, 0x40,
		0x40, 0xA0, 0x40, 0xA0, 0x40,
		0x40, 0xA0, 0x60, 0x20, 0x40,
		0x40, 0xA0, 0xE0, 0xA0, 0xA0,
		0xC0, 0xA0, 0xC0, 0xA0, 0xC0,
		0x60, 0x80, 0x80, 0x80, 0x60,
		0xC0, 0xA0, 0xA0, 0xA0, 0xC0,
		0xE0, 0x80, 0xC0, 0x80, 0xE0,
		0xE0, 0x80, 0xC0, 0x80, 0x80,
	],
}
var bigfonts = {
	octo: [
		0xFF, 0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, // 0
		0x18, 0x78, 0x78, 0x18, 0x18, 0x18, 0x18, 0x18, 0xFF, 0xFF, // 1
		0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, // 2
		0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, // 3
		0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, 0x03, 0x03, 0x03, 0x03, // 4
		0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, // 5
		0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, // 6
		0xFF, 0xFF, 0x03, 0x03, 0x06, 0x0C, 0x18, 0x18, 0x18, 0x18, // 7
		0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, // 8
		0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, // 9
		0x7E, 0xFF, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, 0xC3, 0xC3, 0xC3, // A
		0xFC, 0xFC, 0xC3, 0xC3, 0xFC, 0xFC, 0xC3, 0xC3, 0xFC, 0xFC, // B
		0x3C, 0xFF, 0xC3, 0xC0, 0xC0, 0xC0, 0xC0, 0xC3, 0xFF, 0x3C, // C
		0xFC, 0xFE, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFE, 0xFC, // D
		0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, // E
		0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0  // F
	],
	schip: [
		0x3C, 0x7E, 0xE7, 0xC3, 0xC3, 0xC3, 0xC3, 0xE7, 0x7E, 0x3C,
		0x18, 0x38, 0x58, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C,
		0x3E, 0x7F, 0xC3, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xFF, 0xFF,
		0x3C, 0x7E, 0xC3, 0x03, 0x0E, 0x0E, 0x03, 0xC3, 0x7E, 0x3C,
		0x06, 0x0E, 0x1E, 0x36, 0x66, 0xC6, 0xFF, 0xFF, 0x06, 0x06,
		0xFF, 0xFF, 0xC0, 0xC0, 0xFC, 0xFE, 0x03, 0xC3, 0x7E, 0x3C,
		0x3E, 0x7C, 0xE0, 0xC0, 0xFC, 0xFE, 0xC3, 0xC3, 0x7E, 0x3C,
		0xFF, 0xFF, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x60, 0x60,
		0x3C, 0x7E, 0xC3, 0xC3, 0x7E, 0x7E, 0xC3, 0xC3, 0x7E, 0x3C,
		0x3C, 0x7E, 0xC3, 0xC3, 0x7F, 0x3F, 0x03, 0x03, 0x3E, 0x7C,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // no hex chars!
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	],
	fish: [
		0x7C, 0xC6, 0xCE, 0xDE, 0xD6, 0xF6, 0xE6, 0xC6, 0x7C, 0x00, // at most 7x9 pixels!
		0x10, 0x30, 0xF0, 0x30, 0x30, 0x30, 0x30, 0x30, 0xFC, 0x00,
		0x78, 0xCC, 0xCC, 0x0C, 0x18, 0x30, 0x60, 0xCC, 0xFC, 0x00,
		0x78, 0xCC, 0x0C, 0x0C, 0x38, 0x0C, 0x0C, 0xCC, 0x78, 0x00,
		0x0C, 0x1C, 0x3C, 0x6C, 0xCC, 0xFE, 0x0C, 0x0C, 0x1E, 0x00,
		0xFC, 0xC0, 0xC0, 0xC0, 0xF8, 0x0C, 0x0C, 0xCC, 0x78, 0x00,
		0x38, 0x60, 0xC0, 0xC0, 0xF8, 0xCC, 0xCC, 0xCC, 0x78, 0x00,
		0xFE, 0xC6, 0xC6, 0x06, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x00,
		0x78, 0xCC, 0xCC, 0xEC, 0x78, 0xDC, 0xCC, 0xCC, 0x78, 0x00,
		0x7C, 0xC6, 0xC6, 0xC6, 0x7C, 0x18, 0x18, 0x30, 0x70, 0x00,
		0x30, 0x78, 0xCC, 0xCC, 0xCC, 0xFC, 0xCC, 0xCC, 0xCC, 0x00,
		0xFC, 0x66, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x66, 0xFC, 0x00,
		0x3C, 0x66, 0xC6, 0xC0, 0xC0, 0xC0, 0xC6, 0x66, 0x3C, 0x00,
		0xF8, 0x6C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x6C, 0xF8, 0x00,
		0xFE, 0x62, 0x60, 0x64, 0x7C, 0x64, 0x60, 0x62, 0xFE, 0x00,
		0xFE, 0x66, 0x62, 0x64, 0x7C, 0x64, 0x60, 0x60, 0xF0, 0x00,
	],
	none: new Array(16*10).fill(0x00),
}
var fontsets = {
	octo     : { small: smallfonts.octo,      big: bigfonts.octo  },
	vip      : { small: smallfonts.vip,       big: bigfonts.none  },
	dream6800: { small: smallfonts.dream6800, big: bigfonts.none  },
	eti660   : { small: smallfonts.eti660,    big: bigfonts.none  },
	schip    : { small: smallfonts.octo,      big: bigfonts.schip },
	fish     : { small: smallfonts.fish,      big: bigfonts.fish  },
}

////////////////////////////////////
//
//   The Chip8 Interpreter:
//
////////////////////////////////////

function Emulator() {

	// persistent configuration settings
	this.tickrate           = 20;
	this.fillColor          = "#FFCC00";
	this.fillColor2         = "#FF6600";
	this.blendColor         = "#662200";
	this.backgroundColor    = "#996600";
	this.buzzColor          = "#FFAA00";
	this.quietColor         = "#000000";
	this.shiftQuirks        = false;
	this.loadStoreQuirks    = false;
	this.vfOrderQuirks      = false;
	this.clipQuirks         = false;
	this.jumpQuirks         = false;
	this.logicQuirks        = false;
	this.vBlankQuirks       = false;
	this.enableXO           = true;
	this.screenRotation     = 0;//must be 0, 90, 180, or 270
	this.maxSize            = 3584;
	this.touchInputMode     = 'none';
	this.maskFormatOverride = true;
	this.numericFormatStr   = "default";
	this.fontStyle          = 'octo';

	// interpreter state
	this.p  = [[],[]];  // pixels
	this.m  = [];       // memory (bytes)
	this.r  = [];       // return stack
	this.v  = [];       // registers
	this.pc = 0;        // program counter
	this.i  = 0;        // index register
	this.dt = 0;        // delay timer
	this.st = 0;        // sound timer
	this.pitch   = 64;  // audio pitch register
	this.pattern = [];  // audio pattern buffer
	this.hires = false; // are we in SuperChip high res mode?
	this.flags = [];    // semi-persistent hp48 flag vars
	this.plane = 1;     // graphics plane
	this.profile_data = {};

	// control/debug state
	this.keys = {};       // track keys which are pressed
	this.waiting = false; // are we waiting for a keypress?
	this.waitReg = -1;    // destination register of an awaited key
	this.halted = true;
	this.breakpoint = false;
	this.metadata = {};
	this.tickCounter = 0;
	this.linted = false;

	// external interface stubs
	this.exitVector  = function() {}                                                           // fired by 'exit'
	this.importFlags = function() { return [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]; } // load persistent flags
	this.exportFlags = function(flags) {}                                                      // save persistent flags
	this.buzzTimer   = function(timer) {}
	this.buzzBuffer  = function(buffer) {}
	this.buzzPitch   = function(pitch) {}

	this.init = function(rom) {
		// initialise memory with a new array to ensure that it is of the right size and is initiliased to 0
		this.m = this.enableXO ? new Uint8Array(0x10000) : new Uint8Array(0x1000);

		this.p = [[], []];
		if (this.enableXO)
			for(var z = 0; z < 64*128; z++) { this.p[0][z] = 0; this.p[1][z] = 0; }
		else
			for(var z = 0; z < 32*64; z++) { this.p[0][z] = 0; this.p[1][z] = 0; }

		// initialize memory
		var font = fontsets[this.fontStyle];
		for(var z = 0; z < 32*64;            z++) { this.p[0][z] = 0; this.p[1][z] = 0; }
		for(var z = 0; z < font.small.length;z++) { this.m[z] = font.small[z]; }
		for(var z = 0; z < font.big.length;  z++) { this.m[z + font.small.length] = font.big[z]; }
		for(var z = 0; z < rom.rom.length;   z++) { this.m[0x200+z] = rom.rom[z]; }
		for(var z = 0; z < 16;               z++) { this.v[z] = 0; }
		for(var z = 0; z < 16;               z++) { this.pattern[z] = 0; }

		// initialize interpreter state
		this.r = [];
		this.pc = 0x200;
		this.i  = 0;
		this.dt = 0;
		this.st = 0;
		this.pitch = 64;
		this.hires = false;
		this.plane = 1;

		// initialize control/debug state
		this.keys = {};
		this.waiting = false;
		this.waitReg = -1;
		this.halted = false;
		this.breakpoint = false;
		this.stack_breakpoint = -1;
		this.metadata = rom;
		this.tickCounter = 0;
		this.profile_data = {};
	}

	this.writeCarry = function(dest, value, flag) {
		this.v[dest] = (value & 0xFF);
		this.v[0xF] = flag ? 1 : 0;
		if (this.vfOrderQuirks) {
			this.v[dest] = (value & 0xFF);
		}
	}

	this.math = function(x, y, op) {
		// basic arithmetic opcodes
		switch(op) {
			case 0x0: this.v[x]  = this.v[y]; break;
			case 0x1: this.v[x] |= this.v[y]; if (this.logicQuirks) this.v[0xF]=0; break;
			case 0x2: this.v[x] &= this.v[y]; if (this.logicQuirks) this.v[0xF]=0; break;
			case 0x3: this.v[x] ^= this.v[y]; if (this.logicQuirks) this.v[0xF]=0; break;
			case 0x4:
				var t = this.v[x]+this.v[y];
				this.writeCarry(x, t, (t > 0xFF));
				break;
			case 0x5:
				var t = this.v[x]-this.v[y];
				this.writeCarry(x, t, (this.v[x] >= this.v[y]));
				break;
			case 0x7:
				var t = this.v[y]-this.v[x];
				this.writeCarry(x, t, (this.v[y] >= this.v[x]));
				break;
			case 0x6:
				if (this.shiftQuirks) { y = x; }
				var t = this.v[y] >> 1;
				this.writeCarry(x, t, (this.v[y] & 0x1));
				break;
			case 0xE:
				if (this.shiftQuirks) { y = x; }
				var t = this.v[y] << 1;
				this.writeCarry(x, t, ((this.v[y] >> 7) & 0x1));
				break;
			default:
				haltBreakpoint("unknown math opcode "+op.toString(16).toUpperCase());
		}
	}

	this.misc = function(x, rest) {
		// miscellaneous opcodes
		switch(rest) {
			case 0x01: this.plane = (x & 0x3); break;
			case 0x02:
				for(var z = 0; z < 16; z++) this.pattern[z] = this.m[this.i+z];
				this.buzzBuffer(this.pattern); break;
			case 0x07: this.v[x] = this.dt; break;
			case 0x0A: this.waiting = true; this.waitReg = x; break;
			case 0x15: this.dt = this.v[x]; break;
			case 0x18: this.buzzTimer(this.st = this.v[x]); break;
			case 0x1E: this.i = (this.i + this.v[x])&0xFFFF; break;
			case 0x29: this.i = ((this.v[x] & 0xF) * 5); break;
			case 0x30: this.i = ((this.v[x] & 0xF) * 10 + fontsets[this.fontStyle].small.length); break;
			case 0x33:
				this.m[this.i]   = Math.floor(this.v[x]/100)%10;
				this.m[this.i+1] = Math.floor(this.v[x]/10)%10;
				this.m[this.i+2] = this.v[x]%10;
				break;
			case 0x3A: this.buzzPitch(this.pitch = this.v[x]); break;
			case 0x55:
				for(var z = 0; z <= x; z++) { this.m[this.i+z] = this.v[z]; }
				if (!this.loadStoreQuirks) { this.i = (this.i+x+1)&0xFFFF; }
				break;
			case 0x65:
				for(var z = 0; z <= x; z++) { this.v[z] = this.m[this.i+z]; }
				if (!this.loadStoreQuirks) { this.i = (this.i+x+1)&0xFFFF; }
				break;
			case 0x75:
				for(var z = 0; z <= x; z++) { this.flags[z] = this.v[z]; }
				this.exportFlags(this.flags);
				break;
			case 0x85:
				this.flags = this.importFlags();
				if (typeof this.flags == "undefined" || this.flags == null) {
					this.flags = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
				}
				for(var z = 0; z <= x; z++) { this.v[z] = 0xFF & this.flags[z]; }
				break;
			default:
				haltBreakpoint("unknown misc opcode "+rest.toString(16).toUpperCase());
		}
	}

	this.sprite = function sprite(x, y, len) {
		this.v[0xF] = 0x0;
		var rowSize = this.hires ? 128 : 64;
		var colSize = this.hires ?  64 : 32;
		var i = this.i;
		for(var layer = 0; layer < 2; layer++) {
			if ((this.plane & (layer+1)) == 0) { continue; }
			if (len == 0) {
				// draw a SuperChip 16x16 sprite
				for(var a = 0; a < 16; a++) {
					for(var b = 0; b < 16; b++) {
						var target = ((x+b) % rowSize) + ((y+a) % colSize)*rowSize;
						var source = ((this.m[i+(a*2)+(b > 7 ? 1:0)] >> (7-(b%8))) & 0x1) != 0;
						if (this.clipQuirks) {
							if ((x%rowSize)+b>=rowSize || (y%colSize)+a>=colSize) { source = 0; }
						}
						if (!source) { continue; }
						if (this.p[layer][target]) { this.p[layer][target] = 0; this.v[0xF] = 0x1; }
						else { this.p[layer][target] = 1; }
					}
				}
				i += 32;
			}
			else {
				// draw a Chip8 8xN sprite
				for(var a = 0; a < len; a++) {
					for(var b = 0; b < 8; b++) {
						var target = ((x+b) % rowSize) + ((y+a) % colSize)*rowSize;
						var source = ((this.m[i+a] >> (7-b)) & 0x1) != 0;
						if (this.clipQuirks) {
							if ((x%rowSize)+b>=rowSize || (y%colSize)+a>=colSize) { source = 0; }
						}
						if (!source) { continue; }
						if (this.p[layer][target]) { this.p[layer][target] = 0; this.v[0xF] = 0x1; }
						else { this.p[layer][target] = 1; }
					}
				}
				i += len;
			}
		}
	}

	this.call = function(nnn) {
		if (this.r.length >= 12) {
			haltBreakpoint("call stack overflow.");
		}
		this.r.push(this.pc);
		this.pc = nnn
	}

	this.jump0 = function(nnn) {
		if (this.jumpQuirks) { this.pc = nnn + this.v[(nnn >> 8)&0xF];  }
		else                 { this.pc = nnn + this.v[0]; }
	}

	this.machine = function(nnn) {
		if (nnn == 0x000) { this.halted = true; return; }
		haltBreakpoint("machine code is not supported.");
	}

	this.skip = function() {
		var op = (this.m[this.pc  ] << 8) | this.m[this.pc+1];
		this.pc += (op == 0xF000) ? 4 : 2;
	}

	this.opcode = function() {
		// Increment profilining data
		this.profile_data[this.pc] = (this.profile_data[this.pc] || 0) + 1;

		// decode the current opcode
		var op  = (this.m[this.pc  ] << 8) | this.m[this.pc+1];
		var o   = (this.m[this.pc  ] >> 4) & 0x00F;
		var x   = (this.m[this.pc  ]     ) & 0x00F;
		var y   = (this.m[this.pc+1] >> 4) & 0x00F;
		var n   = (this.m[this.pc+1]     ) & 0x00F;
		var nn  = (this.m[this.pc+1]     ) & 0x0FF;
		var nnn = op & 0xFFF;
		this.pc += 2;

		// execute a simple opcode
		if (op == 0x00E0) {
			// clear
			for(var layer = 0; layer < 2; layer++) {
				if ((this.plane & (layer+1)) == 0) { continue; }
				for(var z = 0; z < this.p[layer].length; z++) {
					this.p[layer][z] = 0;
				}
			}
			return;
		}
		if (op == 0x00EE) {
			// return
			this.pc = this.r.pop();
			return;
		}
		if ((op & 0xF0FF) == 0xE09E) {
			// if -key
			if (Object.keys(keymap[this.v[x]]||{}).some(x => x in this.keys)) { this.skip(); }
			return;
		}
		if ((op & 0xF0FF) == 0xE0A1) {
			// if key
			if (!Object.keys(keymap[this.v[x]]||{}).some(x => x in this.keys)) { this.skip(); }
			return;
		}
		if ((op & 0xFFF0) == 0x00C0) {
			// scroll down n pixels
			var rowSize = this.hires ? 128 : 64;
			for(var layer = 0; layer < 2; layer++) {
				if ((this.plane & (layer+1)) == 0) { continue; }
				for(var z = this.p[layer].length - 1; z >= 0; z--) {
					this.p[layer][z] = (z >= rowSize * n) ? this.p[layer][z - (rowSize * n)] : 0;
				}
			}
			return;
		}
		if ((op & 0xFFF0) == 0x00D0) {
			// scroll up n pixels
			var rowSize = this.hires ? 128 : 64;
			for(var layer = 0; layer < 2; layer++) {
				if ((this.plane & (layer+1)) == 0) { continue; }
				for(var z = 0; z < this.p[layer].length; z++) {
					this.p[layer][z] = (z < (this.p[layer].length - rowSize * n)) ? this.p[layer][z + (rowSize * n)] : 0;
				}
			}
			return;
		}
		if (op == 0x00FB) {
			// scroll right 4 pixels
			var rowSize = this.hires ? 128 : 64;
			for(var layer = 0; layer < 2; layer++) {
				if ((this.plane & (layer+1)) == 0) { continue; }
				for(var a = 0; a < this.p[layer].length; a += rowSize) {
					for(var b = rowSize-1; b >= 0; b--) {
						this.p[layer][a + b] = (b > 3) ? this.p[layer][a + b - 4] : 0;
					}
				}
			}
			return;
		}
		if (op == 0x00FC) {
			// scroll left 4 pixels
			var rowSize = this.hires ? 128 : 64;
			for(var layer = 0; layer < 2; layer++) {
				if ((this.plane & (layer+1)) == 0) { continue; }
				for(var a = 0; a < this.p[layer].length; a += rowSize) {
					for(var b = 0; b < rowSize; b++) {
						this.p[layer][a + b] = (b < rowSize - 4) ? this.p[layer][a + b + 4] : 0;
					}
				}
			}
			return;
		}
		if (op == 0x00FD) {
			// exit
			this.halted = true;
			this.exitVector();
			return;
		}
		if (op == 0x00FE) {
			// lores
			this.hires = false;
			this.p = [[], []];
			for(var z = 0; z < 32*64; z++) { this.p[0][z] = 0; this.p[1][z] = 0; }
			return;
		}
		if (op == 0x00FF) {
			// hires
			this.hires = true;
			this.p = [[], []];
			for(var z = 0; z < 64*128; z++) { this.p[0][z] = 0; this.p[1][z] = 0; }
			return;
		}
		if (op == 0xF000) {
			// long memory reference
			this.i = ((this.m[this.pc] << 8) | (this.m[this.pc+1])) & 0xFFFF;
			this.pc += 2;
			return;
		}

		if (o == 0x5 && n != 0) {
			if (n == 2) {
				// save range
				var dist = Math.abs(x - y);
				if (x < y) { for(var z = 0; z <= dist; z++) { this.m[this.i+z] = this.v[x+z]; }}
				else       { for(var z = 0; z <= dist; z++) { this.m[this.i+z] = this.v[x-z]; }}
				return;
			}
			else if (n == 3) {
				// load range
				var dist = Math.abs(x - y);
				if (x < y) { for(var z = 0; z <= dist; z++) { this.v[x+z] = this.m[this.i+z]; }}
				else       { for(var z = 0; z <= dist; z++) { this.v[x-z] = this.m[this.i+z]; }}
				return;
			}
			else {
				haltBreakpoint("unknown opcode "+op.toString(16).toUpperCase());
			}
		}
		if (o == 0x9 && n != 0) {
			haltBreakpoint("unknown opcode "+op.toString(16).toUpperCase());
		}

		// dispatch complex opcodes
		switch(o) {
			case 0x0: this.machine(nnn);                            break;
			case 0x1: this.pc = nnn;                                break;
			case 0x2: this.call(nnn);                               break;
			case 0x3: if (this.v[x] == nn)        { this.skip(); }  break;
			case 0x4: if (this.v[x] != nn)        { this.skip(); }  break;
			case 0x5: if (this.v[x] == this.v[y]) { this.skip(); }  break;
			case 0x6: this.v[x] = nn;                               break;
			case 0x7: this.v[x] = (this.v[x] + nn) & 0xFF;          break;
			case 0x8: this.math(x, y, n);                           break;
			case 0x9: if (this.v[x] != this.v[y]) { this.skip(); }  break;
			case 0xA: this.i = nnn;                                 break;
			case 0xB: this.jump0(nnn);                              break;
			case 0xC: this.v[x] = (Math.random()*256)&nn;           break;
			case 0xD: this.sprite(this.v[x], this.v[y], n);         break;
			case 0xF: this.misc(x, nn);                             break;
			default: haltBreakpoint("unknown opcode "+o.toString(16).toUpperCase());
		}
	}

	this.tick = function() {
		if (this.halted) { return; }
		this.tickCounter++;
		try {
			this.opcode();
		}
		catch(err) {
			console.log("halted: " + err);
			this.halted = true;
		}
	}
}
</script>
<script>"use strict";

////////////////////////////////////
//
//   Emulator Execution
//
////////////////////////////////////

//must be set > 0
var scaleFactor = 5;
//dom id for canvas element
var renderTarget = "target";

const optionFlags = [
	"tickrate",
	"fillColor",
	"fillColor2",
	"blendColor",
	"backgroundColor",
	"buzzColor",
	"quietColor",
	"shiftQuirks",
	"loadStoreQuirks",
	"vfOrderQuirks",
	"clipQuirks",
	"vBlankQuirks",
	"jumpQuirks",
	"screenRotation",
	"maxSize",
	"touchInputMode",
	"logicQuirks",
	"fontStyle",
]
function unpackOptions(emulator, options) {
	optionFlags.forEach(x => { if (x in options) emulator[x] = options[x] })
	if (options["enableXO"]) emulator.maxSize = 65024 // legacy option
}
function packOptions(emulator) {
	const r = {}
	optionFlags.forEach(x => r[x] = emulator[x])
	return r
}

function setRenderTarget(scale, canvas) {
	scaleFactor = scale;
	renderTarget = canvas;
	var c = document.getElementById(canvas);

	// Remove any existing previous delta frame so first frame is always drawn:
	c.last = undefined;

	var w  = scaleFactor * 128;
	var h  = scaleFactor *  64;

	if (emulator.screenRotation == 90 || emulator.screenRotation == 270) {
		c.width  = h;
		c.height = w;
	}
	else {
		c.width  = w;
		c.height = h;
	}
}

function setTransform(emulator, g) {
	g.setTransform(1, 0, 0, 1, 0, 0);
	var x = scaleFactor * 128;
	var y = scaleFactor *  64;
	switch(emulator.screenRotation) {
		case 90:
			g.rotate(0.5 * Math.PI);
			g.translate(0, -y);
			break;
		case 180:
			g.rotate(1.0 * Math.PI);
			g.translate(-x, -y);
			break;
		case 270:
			g.rotate(1.5 * Math.PI);
			g.translate(-x, 0);
			break;
		default:
			console.assert(emulator.screenRotation === 0, 'Screen rotation not set to 0, 90, 180, or 270. Treating as 0.')
	}
}


function arrayEqual(a, b) {
	var length = a.length;
	if (length !== b.length) { return false; }
	for (var i = 0; i < length; i++) {
		if (a[i] !== b[i]) { return false; }
	}
	return true;
}

function getColor(id) {
	switch(id) {
		case 0: return emulator.backgroundColor;
		case 1: return emulator.fillColor;
		case 2: return emulator.fillColor2;
		case 3: return emulator.blendColor;
	}
	throw "invalid color: " + id;
}

function renderDisplay(emulator) {
	var c = document.getElementById(renderTarget);

	// Canvas rendering can be expensive. Exit out early if nothing has changed.
	var colors = [emulator.backgroundColor, emulator.fillColor, emulator.fillColor2, emulator.blendColor];
	if (c.last !== undefined) {
		if (arrayEqual(c.last.p[0], emulator.p[0]) && arrayEqual(c.last.p[1], emulator.p[1])
				&& arrayEqual(c.last.colors, colors)) {
			return;
		}
		if (c.last.hires !== emulator.hires)
			c.last = undefined;  // full redraw when switching resolution
	}
	var g = c.getContext("2d");
	setTransform(emulator, g);
	var w      = emulator.hires ? 128         : 64;
	var h      = emulator.hires ? 64          : 32;
	var size   = emulator.hires ? scaleFactor : scaleFactor*2;
	var lastPixels = c.last !== undefined? c.last.p: [[], []]

	g.scale(size, size)
	var z = 0;
	for(var y = 0; y < h; ++y) {
		for(var x = 0; x < w; ++x, ++z) {
			var oldColorIdx = lastPixels[0][z] + (lastPixels[1][z] << 1);
			var colorIdx = emulator.p[0][z] + (emulator.p[1][z] << 1);
			if (oldColorIdx !== colorIdx) {
				g.fillStyle = getColor(colorIdx);
				g.fillRect(x, y, 1, 1);
			}
		}
	}
	g.scale(1, 1) //restore scale to 1,1 just in case

	c.last = {
		colors: colors,
		p: [emulator.p[0].slice(), emulator.p[1].slice()],
		hires: emulator.hires,
	};
}

////////////////////////////////////
//
//   Audio Playback
//
////////////////////////////////////

var audio;
var audioNode;
var audioSource;
var audioData;
var XOAudio;

var AudioBuffer = function(buffer, duration) {
	if (!(this instanceof AudioBuffer)) {
		return new AudioBuffer(buffer, duration);
	}

	this.pointer = 0;
	this.buffer = buffer;
	this.duration = duration;
}

AudioBuffer.prototype.write = function(buffer, index, size) {
	size = Math.max(0, Math.min(size, this.duration))
	if (!size) { return size; }

	this.duration -= size;
	var bufferSize = this.buffer.length;
	var end = index + size;

	for(var i = index; i < end; ++i) {
		buffer[i] = this.buffer[this.pointer++];
		this.pointer %= bufferSize;
	}

	return size;
}

AudioBuffer.prototype.dequeue = function(duration) {
	this.duration -= duration;
}

var FREQ = 4000;
var PITCH_BIAS = 64;

function audioEnable() {
	// this will only work if called directly from a user-generated input handler:
	if (audio && audio.state == 'suspended') audio.resume()
}

function audioSetup(emulator) {
	if (!audio) {
		if (typeof AudioContext !== 'undefined') {
			audio = new AudioContext();
		}
		else if (typeof webkitAudioContext !== 'undefined') {
			audio = new webkitAudioContext();
		}
	}
	audioEnable()
	if (audio && !audioNode) {
		const bufferSize = // set bufferSize according to environment's samplerate
		audio.sampleRate <  64000 ? 2048 : // for 48000hz or 44100hz or less
		audio.sampleRate < 128000 ? 4096 : 8192; // for 96000hz or more
		audioNode = audio.createScriptProcessor(bufferSize, 1, 1);
		audioNode.gain = audio.createGain();
		audioNode.gain.gain.value = VOLUME ;
		audioNode.onaudioprocess = function(audioProcessingEvent) {
			var outputBuffer = audioProcessingEvent.outputBuffer;
			var outputData = outputBuffer.getChannelData(0);
			var samples_n = outputBuffer.length;
			var index = 0;
			while(audioData.length && index < samples_n) {
				var size = samples_n - index;
				var written = audioData[0].write(outputData, index, size);
				index += written;
				if (written < size) {
					audioData.shift();
				}
			}

			while(index < samples_n) {
				outputData[index++] = 0;
			}
			//the last one can be long sound with high value of buzzer, so always keep it
			if (audioData.length > 1) {
				var audioDataSize = 0;
				var audioBufferSize = audioNode.bufferSize;
				audioData.forEach(function(buffer) { audioDataSize += buffer.duration; })
				while(audioDataSize > audioBufferSize && audioData.length > 1) {
					audioDataSize -= audioData.shift().duration;
				}
			}
		}
		audioData = [];
		audioNode.connect(audioNode.gain);
		audioNode.gain.connect(audio.destination);

		XOAudio = new AudioControl();
		emulator.buzzTimer  = _ => XOAudio.setTimer(_);
		emulator.buzzBuffer = _ => XOAudio.setBuffer(_);
		emulator.buzzPitch  = _ => XOAudio.setPitch(_);
	}
	return audio && audioNode
}

function stopAudio() {
	if (!audio) { return; }
	if (audioNode) {
		audioNode.disconnect();
		audioNode = null;
	}
	audioData = [];
}

var VOLUME = 0.25;

function playPattern(soundLength,buffer,pitch=PITCH_BIAS,
	sampleState={ pos: 0 }) {
	if (!audio) { return; }
	audioEnable()

	var freq = FREQ*2**((pitch-PITCH_BIAS)/48);
	var samples = Math.ceil(audio.sampleRate * soundLength);
	
	var bufflen = buffer.length * 8;
	var audioBuffer = new Float32Array(samples);

	var step = freq / audio.sampleRate;
	var pos = sampleState.pos;

	// keep super-sampling consistent with audio sample rate
	var quality = Math.ceil( 384000 / audio.sampleRate );
	var lowPassAlpha = getLowPassAlpha(audio.sampleRate * quality);
	
	for(var i = 0, il = samples; i < il; i++) {
		for (var j = 0; j < quality; ++j) {
			var cell = pos >> 3, shift = pos & 7 ^ 7;
			var value = getLowPassFilteredValue(lowPassAlpha, buffer[cell] >> shift & 1);
			pos = ( pos + step/quality ) % bufflen;
		}
		audioBuffer[i] = value;
	}

	audioData.push(new AudioBuffer(audioBuffer, samples));
	
	return { pos };
}

const silentPattern = new Array(64).fill(0);

function AudioControl(){
	this.state = { pos: 0 };
	this.reset = true;
	this.buffer = [];

	this.timer = 0;
	this.pitch = PITCH_BIAS;

	this.refresh = _ => {
		if (this.reset) this.state.pos = 0; this.reset = false;
		if (this.timer == 0) playPattern(_,silentPattern);
		else this.state = playPattern(_,this.buffer,this.pitch,this.state);
		if((this.timer -= this.timer>0) == 0) this.reset = true;
		while(audioData.length > 8) audioData.shift();
	}
	this.setTimer = (timer) => {
		if(timer == 0) this.reset = true;
		this.timer = timer;
	}
	this.setBuffer = buffer => this.buffer = buffer;
	this.setPitch = pitch => this.pitch = pitch;
}

function escapeHtml(str) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
}

// Should be a good way below the Nyquist limit of 22.05 kHz.
const cutoffFrequency = 18000;

// How many filters to put in sequence.
const lowPassFilterSteps = 4;

// Each filter is an exponential filter, which mimics a simple analog RC filter.
// We need multiple of them in series to get decent attenuation near the stop band.

const lowPassBuffer = new Array(lowPassFilterSteps + 1).fill(0);

function getLowPassAlpha(samplingFrequency) {
	const c = Math.cos(2 * Math.PI * cutoffFrequency / samplingFrequency);
	return c - 1 + Math.sqrt(c * c - 4 * c + 3);
}

function getLowPassFilteredValue(alpha, targetValue) {
	lowPassBuffer[0] = targetValue;
	for (let i = 1; i < lowPassBuffer.length; ++i) {
		lowPassBuffer[i] += (lowPassBuffer[i - 1] - lowPassBuffer[i]) * alpha;
	}
	return lowPassBuffer[lowPassBuffer.length - 1];
}
</script>
<script>/**
* Adaptive Input
**/

const ael = (element, event, listener) => element.addEventListener   (event, listener, { passive:false })
const rel = (element, event, listener) => element.removeEventListener(event, listener, { passive:false })
const pd  = event => (event.preventDefault(),event.stopPropagation())

function addPointer(element,start,move,end){
  function mouseToTouch(f){
    return event=>{
      const to={indentifier:1,target:element,clientX:event.clientX,clientY:event.clientY}
      f({changedTouches:[to],touches:[to],preventDefault:_=>{},stopPropagation:_=>{}})
    }
  }
  let mousedown=false
  const events={
    touchstart: start,
    touchmove:  move,
    touchend:   end,
    mousedown:  mouseToTouch(e=>{mousedown=true;start(e)}),
    mousemove:  mouseToTouch(e=>{if(mousedown)move(e)}),
    mouseup:    mouseToTouch(e=>{mousedown=false;end(e)}),
    mouseout:   mouseToTouch(e=>{mousedown=false;end(e)}),
  }
  Object.keys(events).forEach(k=>ael(element,k,events[k]))
  return _=>{Object.keys(events).forEach(k=>rel(element,k,events[k]))}
}

const VIP_HEX  = '123c456d789ea0bf'.split('')
const VIP_KEYS = VIP_HEX.map(x => parseInt(x,16))

const GAMEPAD_STYLES = `
.gamepad{
  position:absolute;
  top:10%;
  left:0px;
  width:100%;
  height:90%;
  opacity:0.3;
  user-select: none;
  -webkit-user-select: none;
}
.gamepad .dpad{
  position:absolute;
  bottom: 50px;
  left:   50px;
  width:  250px;
  height: 250px;
  background: gray;
  border-radius: 50%;
  overflow:hidden;
}
.gamepad .stick{
  display:none;
  position:absolute;
  border-radius: 50%;
  width:100px;
  height:100px;
  margin-left:-50px;
  margin-top:-50px;
}
.gamepad .buttons{
  position:absolute;
  bottom: 50px;
  right:  50px;
  width:  250px;
  height: 250px;
}
.gamepad .gamebutton{
  position:absolute;
  width:  125px;
  height: 125px;
  background:gray;
  border-radius:50%;
  overflow:hidden;
  line-height: 125px;
  font-size:50px;
  font-weight:bold;
  color:darkgray;
  text-align:center;
}
.gamepad .dpad.active .stick {display:block;background:#444}
.gamepad .gamebutton.active{background:#444;}
.gamepad .gamebutton.b{left:0;bottom:0;}
.gamepad .gamebutton.a{right:0;top:0;}
`
const VIP_STYLES = `
.vip-pad {display:flex;flex-direction:column;align-items:center;z-index:2000;}
.vip-pad .keypad {display:flex;flex-direction:column;margin-top:10px;}
.vip-pad .keypad>div {display:flex;flex-direction:row;}
.vip-pad .keypad>div>div {
  -webkit-user-select: none;
  user-select: none;
  background:gray;
  width: 100px;
  height: 51px;
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 1px;
}
.vip-pad .keypad>div>div:active,
.vip-pad .keypad>div>div.active {background:black; border:1px solid white;margin:0px;}
`

const INPUT_MODULES = {
  /**
  * An invisible set of gesture recognizers,
  * giving directional input and an action for taps.
  **/
  swipe: {
    install: (screen,up,down,options) => {

      let vdirs      = []
      let direction  = { i:null, sx:0, sy:0, lx:0, ly:0 }
      let action1    = {}
      let taptimeout = null

      const updateStick = _ => {
        // find the relative position of the stick to its starting point
        const cx = direction.lx - direction.sx
        const cy = direction.ly - direction.sy

        // update the virtual direction buttons
        let t = []
        const DEAD_ZONE = 30
        if (Math.abs(cx) > DEAD_ZONE) t.push(cx < 0 ? options.left : options.right)
        if (Math.abs(cy) > DEAD_ZONE) t.push(cy < 0 ? options.up   : options.down)
        vdirs.forEach(x => (t    .indexOf(x)<0) && up  (x)) // clear keys no longer held
        t    .forEach(x => (vdirs.indexOf(x)<0) && down(x)) // push keys that were not held before
        vdirs = t
      }
      const tapDown= i => {
        if (Object.keys(action1).length == 0) down(options.action1)
        action1[i] = true
        if (i == direction.i) { direction = { i:null, sx:0, sy:0, lx:0, ly:0 } }
        taptimeout = null
      }
      const start = e => {
        const t = e.touches[0]
        const i = t.identifier
        // a single-touch is either directional or a tap...
        if (direction.i != null) {
          tapDown(i)
        }
        else {
          direction.i  = i
          direction.sx = t.clientX
          direction.sy = t.clientY
          direction.lx = t.clientX
          direction.ly = t.clientY
          taptimeout = setTimeout(_ => tapDown(i), 100)
        }
        updateStick(),pd(e)
      }
      const move = e => {
        for(let z = 0; z < e.changedTouches.length; z++) {
          const t = e.changedTouches[z]
          const i = t.identifier
          if (i == direction.i) {
            if (taptimeout != null) { clearTimeout(taptimeout); taptimeout = null }
            direction.lx = t.clientX
            direction.ly = t.clientY
          }
        }
        updateStick(),pd(e)
      }
      const end = e => {
        let r1 = false
        for(let z = 0; z < e.changedTouches.length; z++) {
          const t = e.changedTouches[z]
          const i = t.identifier
          if (i == direction.i) {
            if (taptimeout != null) {
              // cancel a short tap
              clearTimeout(taptimeout); taptimeout = null
              down(options.action1)
              setTimeout(_ => up(options.action1), 50)
            }
            direction = { i:null, sx:0, sy:0, lx:0, ly:0 }
          }
          if (i in action1) {
            delete action1[i]
            r1=true
          }
        }
        if (r1 && Object.keys(action1).length == 0) up(options.action1)
        updateStick(),pd(e)
      }
      ael(screen, 'touchstart', start)
      ael(screen, 'touchmove',  move)
      ael(screen, 'touchend',   end)
      screen.uninstallSwipe = _ => {
        rel(screen, 'touchstart', start)
        rel(screen, 'touchmove',  move)
        rel(screen, 'touchend',   end)
      }
    },
    remove: (screen) => {
      screen.uninstallSwipe()
      delete screen.uninstallSwipe
    }
  },

  /**
  * A virtual gamepad overlay with two remappable action keys.
  **/
  gamepad: {
    install: (screen,up,down,options) => {
      // build the UI
      if (document.querySelector('.gamepad')) return
      const root = document.createElement('div')
      root.classList.add('gamepad')
      root.innerHTML = `
      <div class='dpad'><div class='stick'></div></div>
      <div class='buttons'><div class='gamebutton b'>B</div><div class='gamebutton a'>A</div></div>
      <style>${GAMEPAD_STYLES}</style>`
      screen.parentElement.append(root)

      let vdirs      = []
      let directions = {}
      let buttons    = {}
      const pad   = document.querySelector('.gamepad .dpad')
      const stick = document.querySelector('.gamepad .dpad .stick')
      const a     = document.querySelector('.gamepad .gamebutton.a')
      const b     = document.querySelector('.gamepad .gamebutton.b')

      const updateStick = _ => {
        // find centroid of d-pad touchpoints ({0,0} if no touchpoints)
        const touches = Object.values(directions)
        let cx = 0, cy = 0, r = pad.getBoundingClientRect(), sr = stick.getBoundingClientRect()
        touches.forEach(t => (cx+=t.x, cy+=t.y))
        cx /= touches.length,         cy /= touches.length
        cx -= (r.left + (r.width/2)), cy -= (r.top + (r.height/2))

        // position the virtual stick, clamped within dpad
        const ca = Math.atan2(cy, cx)
        const cd = Math.min(Math.sqrt(cx*cx + cy*cy), (r.width/2)-(sr.width/2))
        stick.style.left = ((Math.cos(ca)*cd)+(r.width /2)|0)+'px'
        stick.style.top  = ((Math.sin(ca)*cd)+(r.height/2)|0)+'px'

        // update the virtual direction buttons
        let t = []
        const DEAD_ZONE = 30
        if (Math.abs(cx) > DEAD_ZONE) t.push(cx < 0 ? options.left : options.right)
        if (Math.abs(cy) > DEAD_ZONE) t.push(cy < 0 ? options.up   : options.down)
        vdirs.forEach(x => (t    .indexOf(x)<0) && up  (x)) // clear keys no longer held
        t    .forEach(x => (vdirs.indexOf(x)<0) && down(x)) // push keys that were not held before
        vdirs = t
      }

      const start = e => {
        for(let z = 0; z<e.touches.length; z++) {
          const t = e.touches[z]
          const i = t.identifier
          if (t.target == a) {
            t.target.classList.add('active')
            buttons[i]=options.action1
            down(options.action1)
          }
          if (t.target == b) {
            t.target.classList.add('active')
            buttons[i]=options.action2
            down(options.action2)
          }
          if (t.target == pad) {
            t.target.classList.add('active')
            directions[i]={x:t.clientX, y:t.clientY}
          }
        }
        updateStick(),pd(e)
      }
      const move = e => {
        for(let z = 0; z<e.changedTouches.length; z++) {
          const t = e.changedTouches[z]
          const i = t.identifier
          if (i in directions) directions[i]={x:t.clientX, y:t.clientY}
        }
        updateStick(),pd(e)
      }
      const end = e => {
        for(let z = 0; z<e.changedTouches.length; z++) {
          const t = e.changedTouches[z]
          const i = t.identifier
          if (i in buttons) {
            t.target.classList.remove('active')
            up(buttons[i])
            delete buttons[i]
          }
          if (i in directions) {
            t.target.classList.remove('active')
            delete directions[i]
          }
        }
        updateStick(),pd(e)
      }

      ael(a,   'touchstart', start)
      ael(a,   'touchend',   end  )
      ael(b,   'touchstart', start)
      ael(b,   'touchend',   end  )
      ael(pad, 'touchstart', start)
      ael(pad, 'touchmove',  move )
      ael(pad, 'touchend',   end  )
    },
    remove: (screen) => {
      document.querySelector('.gamepad').remove()
    },
  },

  /**
  * Treat the entire screen, or a centered square region, as invisible buttons,
  * mapped out in the order of the VIP hex keypad.
  **/
  seg16: {
    install: (screen,up,down,options) => {
      const tmap = {}
      const pointToKey = touch => {
        // poll this for each point, as it may vary over time,
        // and experimentally it's never right initially...
        const r = screen.getBoundingClientRect()
        if (options.mode == 'center') {
          if (r.width > r.height) { r.x += (r.width - r.height)/2; r.width = r.height }
          else                    { r.y += (r.height - r.width)/2; r.height = r.width }
        }
        const x = touch.clientX - r.x
        const y = touch.clientY - r.y
        if (x < 0 || x > r.width || y < 0 || y > r.height) return null
        const tx = Math.floor(x / (r.width /4))
        const ty = Math.floor(y / (r.height/4))
        return VIP_KEYS[tx + (4 * ty)]
      }
      const start = e => {
        for(let z=0; z<e.touches.length; z++) {
          const i = e.touches[z].identifier
          const k = pointToKey(e.touches[z])
          if (k != null) down(k)
          tmap[i]=k
        }
        pd(e)
      }
      const move = e => {
        for(let z=0; z<e.touches.length; z++) {
          const i = e.touches[z].identifier
          const k = pointToKey(e.touches[z])
          if (tmap[i] == k) continue       // same cell, nothing to do.
          if (tmap[i] != null) up(tmap[i]) // release old key, if any
          if (k != null)       down(k)     // press new key, if any
          tmap[i]=k
        }
        pd(e)
      }
      const end = e => {
        for(let z=0; z<e.changedTouches.length; z++) {
          const i = e.changedTouches[z].identifier
          const k = pointToKey(e.changedTouches[z])
          if (tmap[i] != null) up(tmap[i])
          tmap[i]=null
        }
        pd(e)
      }
      screen.uninstallSeg16=addPointer(screen,start,move,end)
    },
    remove:  (screen) => {
      screen.uninstallSeg16()
      delete screen.uninstallSeg16
    },
  },

  /**
  * Provide a visible 4x4 representation of the VIP hex keypad.
  **/
  vip: {
    install: (screen,up,down,options) => {
      if (document.querySelector('.vip-pad')) return
      const root = document.createElement('div')
      root.classList.add('vip-pad')
      root.innerHTML = `<div class='keypad'>
        ${[0,1,2,3].map(r=>`<div>${[0,1,2,3].map(c=>`<div>${VIP_HEX[c+(r*4)].toUpperCase()}</div>`).join('')}</div>`).join('')}
      </div>
      <style>${VIP_STYLES}</style>`
      if (screen.parentElement == document.body) { screen.parentElement.append(root) }
      else { screen.parentElement.parentElement.append(root) }
      const buttons = []
      document.querySelectorAll('.vip-pad .keypad>div>div').forEach(x=>buttons.push(x)) // make an actual Array
      const held = {}
      const start = e => {
        for(let z=0; z<e.touches.length; z++) {
          const t = e.touches[z]
          const i = t.identifier
          const k = VIP_KEYS[buttons.indexOf(t.target)]
          t.target.classList.add('active')
          down(k)
          held[i]=k
        }
        pd(e)
      }
      const end = e => {
        for(let z = 0; z<e.changedTouches.length; z++) {
          const t = e.changedTouches[z]
          const i = t.identifier
          if (held[i] != undefined) { up(held[i]); delete held[i] }
          t.target.classList.remove('active')
        }
        pd(e)
      }
      buttons.forEach(b => addPointer(b,start,_=>{},end))
    },
    remove:  (screen) => {
      document.querySelector('.vip-pad').remove()
    },
  },
}

let adaptiveControlsInstalled = null

function injectAdaptiveControls(type, screen, keyup, keydown) {
  let options = {
    up:      5,
    down:    8,
    left:    7,
    right:   9,
    action1: 6,
    action2: 4,
    mode:    'center', // or 'fill', used by seg16
  }
  const lookup = vk => Object.keys(keymap[vk])[0]
  const install = _ => {
    rel(screen, 'touchstart', install)
    rel(screen, 'mousedown',  install)
    adaptiveControlsInstalled = type
    INPUT_MODULES[type].install(
      screen,
      key => keyup  ({ key:lookup(key), preventDefault:_=>_ }),
      key => keydown({ key:lookup(key), preventDefault:_=>_ }),
      options
    )
  }
  // uninstall anything that's already there:
  rel(screen, 'touchstart', install)
  rel(screen, 'mousedown' , install)
  if (adaptiveControlsInstalled) INPUT_MODULES[adaptiveControlsInstalled].remove(screen)

  if (type == 'none') return
  if (type == 'seg16fill') { type='seg16'; options.mode='fill' }
  if (type in {seg16:1,seg16fill:1}){
    install()
  }
  else {
    // defer installing adaptive input until we actually see
    // an input event from the user:
    ael(screen, 'touchstart', install)
    ael(screen, 'mousedown',  install)
  }
}
</script>
<body><canvas id='target' width=512 height=256></canvas></body>
<style>body{margin:0px;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;}</style>
<script>
const emulator = new Emulator()
unpackOptions(emulator, data.options)
setRenderTarget(data.options.displayScale || 4, 'target')
emulator.init({rom:data.rom})
emulator.importFlags = _ => getPref('octoFlagRegisters')
emulator.exportFlags = f => setPref('octoFlagRegisters',f)
emulator.buzzTrigger = (ticks,rest)=> playPattern(ticks, emulator.pattern, rest)
const kd = e=>{
	if (!audio) audioSetup(emulator)
	if (!(e.key in emulator.keys)) emulator.keys[e.key]=true
	e.preventDefault()
}
const ku = e=>{
	if (e.key in emulator.keys) delete emulator.keys[e.key]
	if (!emulator.waiting) return
	const kindex = keymapInverse[e.key]
	if (kindex != undefined) {
		emulator.waiting = false
		emulator.v[emulator.waitReg] = kindex
	}
	e.preventDefault()
}
window.addEventListener('keydown',kd,false)
window.addEventListener('keyup',ku,false)
const frameTime=1000/60
let last=Date.now(), origin=last+frameTime/2
intervalHandle=setInterval(_=>{
	last+=(Date.now()-last)
	if (emulator.halted) return
	for(var k=0; origin<last-frameTime&&k<2; origin+=frameTime,k++){
		for(var z=0;(z<emulator.tickrate) && (!emulator.waiting); z++){
			if (emulator.vBlankQuirks &&((emulator.m[emulator.pc] & 0xF0)==0xD0)) z=emulator.tickrate
			emulator.tick()
		}
		if (emulator.dt > 0) emulator.dt--
		if (emulator.st > 0) emulator.st--
		XOAudio && XOAudio.refresh(frameTime/1000)
	}
	renderDisplay(emulator)
	document.body.style.backgroundColor = emulator.st?emulator.buzzColor:emulator.quietColor
}, frameTime)
injectAdaptiveControls(emulator.touchInputMode,document.getElementById('target'),ku,kd)
</script>
